
## **Peak/Valley 검출 및 실시간 추세 분석 알고리즘 (V4.0)**

### **1. 개요**

#### **1.1. 알고리즘의 목적**

이 문서는 가격 데이터(Open, High, Low, Close)만을 이용하여 **실시간으로 시장의 추세를 객관적으로 분석하고 예측**하는 알고리즘을 상세히 기술합니다. 알고리즘의 핵심 목표는 가격의 움직임 자체에 내재된 패턴을 해석하여, 시장의 방향성이 전환되는 중요한 **고점(Peak)**과 **저점(Valley)**을 탐지하는 것입니다. 이를 통해 트레이더는 특정 종목이나 시장 상황에 구애받지 않고 일관된 기준으로 **상승, 하락, 횡보 추세**를 판단하고, 데이터에 기반한 합리적인 의사결정을 내릴 수 있습니다.

#### **1.2. 핵심 특징**

기존의 많은 기술적 분석 도구들은 특정 지표에 과도하게 의존하거나 미래 데이터를 참조하는 'look-ahead bias'의 한계를 가집니다. 본 알고리즘은 이러한 문제점을 해결하고 실시간성과 범용성을 극대화하기 위해 다음과 같은 핵심 특징을 기반으로 설계되었습니다.

- **지표 및 미래 데이터 불필요**: 이동평균선, RSI 등 보조 지표나 미래 가격 정보 없이, 오직 현재까지 주어진 가격 데이터의 흐름과 구조만으로 추세를 분석하여 실시간 매매 환경에서의 왜곡을 원천적으로 차단합니다.
    
- **종목 및 타임프레임 독립성**: 알고리즘의 판단 기준은 가격 움직임의 보편적인 원칙에 기반하므로, 주식, 암호화폐, 외환 등 자산의 종류나 1분봉, 일봉 등 시간 단위에 관계없이 일관되게 적용될 수 있습니다.
    

---

### **2. 핵심 개념 및 용어 정의**

알고리즘의 동작을 이해하기 위해 다음의 핵심 개념과 용어를 먼저 정의합니다.

#### **2.1. 상태 머신 (State Machine): 추세의 '힘'을 측정하는 엔진**

본 알고리즘은 추세의 발생부터 확정, 소멸까지의 과정을 마치 생명주기처럼 관리하기 위해 **상태 머신** 개념을 도입합니다. 이는 추세의 '힘'과 '신뢰도'를 단계적으로 측정하는 엔진 역할을 합니다.

- **State 0 (관망 상태)**: 추세가 없거나, 이전 추세가 명확히 종료되어 새로운 방향성을 탐색하는 중립적인 상태입니다.
    
- **State 1 (가설 상태)**: 추세가 시작될 수 있다는 최초의 미약한 신호가 포착된 상태입니다. (예: 직전 고점 돌파)
    
- **State 2 (형성 상태)**: 가설이 검증되어 추세가 한 방향으로 힘을 얻기 시작한 상태입니다.
    
- **State 3 (확정 상태)**: 추세가 뚜렷하고 강력하게 한 방향으로 진행 중임이 확인된 가장 신뢰도 높은 상태입니다.
    

#### **2.2. 극점의 신뢰도 모델 (Extremum Confidence Model)**

모든 고점과 저점(극점)은 동일한 중요도를 갖지 않습니다. 본 알고리즘은 극점의 신뢰도와 중요성에 따라 두 가지 등급으로 명확히 구분하여 추세 분석의 정밀도를 높입니다.

- **주요 극점 (Major Extremum)**: 상태 머신이 **State 3 (확정 상태)**의 추세가 명백히 반전되었음을 인지했을 때만 등록되는, **가장 신뢰도가 높은 최종 추세 전환점**입니다. 이 극점은 장기적인 추세의 큰 그림을 그리는 뼈대가 됩니다.
    
    - (내부 용어: **JS Peak/Valley**)
        
- **잠정적 극점 (Provisional Extremum)**: 주요 극점 사이에서 발생하는 의미 있는 **중간 규모의 전환점**입니다. 이 극점들은 아직 주요 극점으로 확정되지는 않았지만, 추세의 세부적인 파동을 그리거나 새로운 추세의 시작 조건(예: 더 높아진 저점)을 판단하는 데 결정적인 역할을 합니다.
    
    - (내부 용어: **Secondary Peak/Valley**)

#### **2.3. 예외 규칙: 내부봉 (Exception Rule: Inside Bar)**

**내부봉은 현재 캔들의 고점(High)이 직전 캔들의 고점보다 낮고, 현재 캔들의 저점(Low)은 직전 캔들의 저점보다 높은 상태를 의미합니다.** 즉, 현재 캔들이 직전 캔들의 가격 범위 안에 완전히 갇혀있는 모양입니다.

- **Price Action 관점**: 내부봉은 시장의 **'일시적인 소강상태' 또는 '에너지 응축'**을 나타냅니다. 매수세와 매도세의 힘이 균형을 이루어, 어느 한쪽으로도 가격을 확장시키지 못하는 것입니다. 이는 다음 움직임을 위한 일종의 "숨 고르기" 상태로, 이 캔들 하나만으로는 추세의 방향성을 판단하기 어렵습니다.
    
- **알고리즘의 전략**: 이런 불확실한 신호를 섣불리 해석하지 않기 위해, 알고리즘은 내부봉이 나타나면 **"판단을 보류하고 현재 추세 상태를 그대로 유지"**하는 전략을 사용합니다.

### **3. 알고리즘 상세 로직**

알고리즘은 세 가지의 독립적이면서도 상호 보완적인 논리 단계를 통해 실시간으로 추세를 분석하고 극점을 탐지합니다.

#### **3.1. 1단계: 주요 극점 탐지 로직 (상태 머신)**

알고리즘의 심장부인 상태 머신은 추세의 탄생부터 소멸까지의 과정을 추적하여, 가장 신뢰도 높은 **주요 극점(Major Extremum)**을 확정하는 역할을 합니다. 모든 판단은 직전 캔들과 현재 캔들의 가격 정보를 비교하여 실시간으로 이루어집니다.

##### **3.1.1. 상태 전이 규칙: State 0 → 1 → 2 → 3 으로 발전하는 조건**

추세는 '관망'에서 시작하여 '가설', '형성', '확정'의 단계를 거쳐 발전합니다.

- **State 0 → 1 (관망 → 가설)**:
    
    - **상승 가설**: 이전 추세가 끝난 후, 가격이 직전의 의미 있는 고점을 넘어서면 상승 추세가 시작될 수 있다는 '가설'을 세웁니다.
        
    - **하락 가설**: 이전 추세가 끝난 후, 가격이 직전의 의미 있는 저점보다 낮아지면 하락 추세가 시작될 수 있다는 '가설'을 세웁니다.
        
- **State 1 → 2 (가설 → 형성)**:
    
    - **상승 형성**: 상승 가설 상태에서, 가격이 고점을 계속 높이고 종가 또한 상승하는 움직임이 나타나면, 가설이 현실화되어 추세가 '형성'되기 시작했다고 판단합니다.
        
    - **하락 형성**: 하락 가설 상태에서, 가격이 저점을 계속 낮추고 종가 또한 하락하는 움직임이 나타나면, 추세가 '형성'되기 시작했다고 판단합니다.
        
- **State 2 → 3 (형성 → 확정)**:
    
    - **상승 확정**: 상승 형성 상태의 움직임이 **미리 정해진 기준 횟수(예: 2회) 이상 연속**으로 관찰되면, 이는 일시적인 반등이 아닌 지속 가능한 힘을 가진 '확정된' 상승 추세로 간주합니다.
        
    - **하락 확정**: 하락 형성 상태의 움직임이 **미리 정해진 기준 횟수 이상 연속**으로 관찰되면, '확정된' 하락 추세로 간주합니다.
        
- **State 1 → 3 (가설 → 즉시 확정)**:
    
    - 예외적으로, 가설 상태에서 직전 캔들의 전체 가격 범위를 압도하는 매우 강력한 움직임이 나타나면, 중간 형성 단계를 건너뛰고 추세를 즉시 '확정'합니다.
        

##### **3.1.2. 상태 리셋 및 방향 전환 규칙**

추세가 항상 한 방향으로만 발전하는 것은 아니므로, 알고리즘은 가설이 깨지거나 추세의 힘이 약해질 때를 인지하고 상태를 전환하거나 초기화합니다.

- **방향 전환 (State 1 ↔ 1, State 2 → 1)**:
    
    - 상승 가설/형성 중에 명확한 하락 신호(저점 하회)가 나타나면, 기존 상승 판단을 즉시 폐기하고 하락 '가설' 상태로 전환하여 새로운 방향성을 탐색합니다.
        
    - 하락 가설/형성 중에도 대칭적으로 동일한 로직이 적용됩니다.
        
- **리셋/초기화 (State 1 → 0, State 2 → 0)**:
    
    - 가설 또는 형성 상태에서 추세가 더 이상 발전하지도(예: 고점 갱신 실패), 명확하게 반대 방향으로 전환되지도 않는 애매한 움직임을 보일 경우, 기존의 모든 판단을 초기화하고 **State 0 (관망 상태)**로 돌아가 시장을 다시 분석합니다.
        

##### **3.1.3. 주요 극점의 최종 확정 조건 (State 3 종료)**

**주요 극점**은 확정된 추세가 명백하게 끝났을 때만 등록됩니다.

- **주요 고점(Major Peak)의 확정**:
    
    1. **조건**: **State 3 (상승 확정)** 상태가 지속되는 동안, 알고리즘은 그 구간 내의 가장 높은 고점을 계속 추적하고 기억합니다.
        
    2. **트리거**: 이 상승 추세가 명백히 꺾였다는 신호, 즉 **가격이 의미 있는 기준 저점을 하방 돌파**하고 **캔들 자체도 음봉으로 마감**하는 이벤트가 발생합니다.
        
    3. **확정**: 이 트리거가 발생한 순간, 알고리즘은 추적해왔던 가장 높은 고점을 **'주요 고점'으로 최종 확정하여 기록**하고, 상태를 하락 '가설' 상태(State 1)로 전환합니다.
        
- **주요 저점(Major Valley)의 확정**:
    
    1. **조건**: **State 3 (하락 확정)** 상태가 지속되는 동안, 알고리즘은 구간 내 가장 낮은 저점을 추적하고 기억합니다.
        
    2. **트리거**: 하락 추세가 명백히 끝났다는 신호, 즉 **가격이 의미 있는 기준 고점을 상방 돌파**하고 **캔들 자체도 양봉으로 마감**하는 이벤트가 발생합니다.
        
    3. **확정**: 이 트리거가 발생한 순간, 추적해왔던 가장 낮은 저점을 **'주요 저점'으로 최종 확정하여 기록**하고, 상태를 상승 '가설' 상태(State 1)로 전환합니다.


#### **3.2. 2단계: 잠정적 극점 탐지 로직 (신뢰도 모델)**

주요 극점이 추세의 큰 뼈대를 이룬다면, 잠정적 극점은 그 뼈대 사이를 잇는 근육과 같습니다. 이 극점들은 추세의 세부적인 파동을 그리며, 특히 새로운 추세가 시작되는 미세한 신호(예: 더 높아진 저점)를 포착하는 데 결정적인 역할을 합니다. 알고리즘은 다음 두 가지의 독립적인 메커니즘을 통해 잠정적 극점을 탐지합니다.

##### **3.2.1. 실시간 승격 (Live Promotion)**

이 메커니즘은 **'반전의 초기 신호'**를 실시간으로 포착하기 위해 설계되었습니다. 마치 공이 바닥에 닿은 후 더 이상 낮게 튀지 않고 다시 튀어 오르기 시작하는 순간을 포착하는 것과 같습니다.

- **탐색 시작**: '주요 고점'이 확정되면, 알고리즘은 '잠정적 저점'을 찾기 위한 추적 상태에 돌입합니다.
    
- **최저점 후보 추적**: 알고리즘은 계속해서 나타나는 저점들 중 **가장 낮은 저점**을 '최저점 후보'로 기억하고 계속 갱신합니다.
    
- **승격 트리거**: 만약 이전에 기억했던 '최저점 후보'보다 **더 높은 새로운 저점**이 나타나면, 알고리즘은 이를 "하락의 힘이 소진되고 상승으로 전환될 가능성이 있다"는 신호로 해석합니다.
    
- **승격 확정**: 이 트리거가 발생하는 즉시, 이전에 기억해 두었던 **'최저점 후보'를 '잠정적 저점'으로 승격**시킵니다.
    

'주요 저점'이 확정된 이후 '잠정적 고점'을 찾는 과정도 이와 정확히 대칭적인 로직으로 동작합니다. (가장 높은 고점을 추적하다가, 더 낮은 새로운 고점이 나타나면 이전의 가장 높았던 고점을 승격)

##### **3.2.2. 소급 승격 (Retrospective Promotion)**

이 메커니즘은 '주요 극점'이 확정되는 순간, 마치 **'역사적인 기록을 재검토'**하여 누락된 중요 변곡점이 있었는지 확인하는 역할을 합니다.

- **탐색 시작**: 새로운 '주요 고점'이 확정되는 순간이 트리거가 됩니다.
    
- **과거 구간 설정**: 알고리즘은 방금 확정된 '주요 고점'과, 그 이전에 확정되었던 **바로 직전의 '주요 고점' 사이의 기간**을 탐색 구간으로 설정합니다.
    
- **후보 탐색 및 검증**: 이 특정 구간 내에서 **가장 낮았던 저점**을 찾아냅니다. 그리고 이 저점이 양쪽에 위치한 두 '주요 고점'보다 명확히 낮은, 의미 있는 저점이었는지 최종적으로 검증합니다.
    
- **승격 확정**: 검증을 통과하면, 해당 저점을 **'잠정적 저점'으로 소급하여 승격**시킵니다.
    

이 '소급 승격' 로직은 실시간 승격 메커니즘이 미처 포착하지 못했을 수 있는, 거시적인 관점의 중요 전환점을 빠짐없이 찾아내어 전체적인 추세 분석의 정확도를 보완합니다. '주요 저점'이 확정된 이후 '잠정적 고점'을 소급하여 찾는 과정도 이와 정확히 대칭적으로 동작합니다.


#### **3.3. 3단계: 최종 추세 판단 로직 (Dow Theory 기반)**

알고리즘의 마지막 단계는 상태 머신과 신뢰도 모델을 통해 탐지된 **모든 극점(주요 및 잠정적)들을 종합**하여, 다우 이론(Dow Theory)에 입각한 최종 시장 추세를 결정하는 것입니다. 추세 판단은 항상 **'횡보(Sideways)' 상태에서 새로운 추세의 시작을 탐색**하고, 일단 추세가 시작되면 **해당 추세의 지속 또는 종료 여부**를 감시하는 방식으로 이루어집니다.

##### **3.3.1. 상승 추세 (Uptrend)**

- 상승 추세의 시작 조건:
    
    '횡보' 상태에서 다음과 같은 두 가지 조건이 동시에 충족될 때 새로운 상승 추세가 시작된 것으로 판단합니다.
    
    1. **더 높은 저점 (Higher Low) 형성**: 가장 최근에 형성된 저점의 가격이, 그 직전 저점의 가격보다 높아야 합니다.
        
    2. **직전 고점 돌파**: 현재 가격이 가장 최근에 형성된 고점의 가격을 상향 돌파해야 합니다.
        
- 상승 추세의 지속 조건:
    
    일단 상승 추세가 시작되면, 아래의 '종료 조건'이 발생하기 전까지는 상승 추세가 지속되는 것으로 간주합니다.
    
- 상승 추세의 종료 조건:
    
    진행 중인 상승 추세는, 현재 가격이 상승 추세를 지지하던 가장 최근의 저점 가격 아래로 하락하면 즉시 종료되고 '횡보' 상태로 전환됩니다. 이는 상승 추세의 핵심 정의인 '더 높은 저점'의 연속성이 깨졌음을 의미하기 때문입니다.
    

##### **3.3.2. 하락 추세 (Downtrend)**

- 하락 추세의 시작 조건:
    
    '횡보' 상태에서 다음과 같은 두 가지 조건이 동시에 충족될 때 새로운 하락 추세가 시작된 것으로 판단합니다.
    
    1. **더 낮은 고점 (Lower High) 형성**: 가장 최근에 형성된 고점의 가격이, 그 직전 고점의 가격보다 낮아야 합니다.
        
    2. **직전 저점 붕괴**: 현재 가격이 가장 최근에 형성된 저점의 가격을 하향 돌파해야 합니다.
        
- 하락 추세의 지속 조건:
    
    일단 하락 추세가 시작되면, 아래의 '종료 조건'이 발생하기 전까지는 하락 추세가 지속되는 것으로 간주합니다.
    
- 하락 추세의 종료 조건:
    
    진행 중인 하락 추세는, 현재 가격이 하락 추세의 저항선 역할을 하던 가장 최근의 고점 가격 위로 상승하면 즉시 종료되고 '횡보' 상태로 전환됩니다. 이는 하락 추세의 핵심 정의인 '더 낮은 고점'의 연속성이 깨졌음을 의미하기 때문입니다.


### **4. 시각화 원칙**

알고리즘이 탐지한 추상적인 개념들(극점, 추세)을 사용자가 직관적으로 이해할 수 있도록, 다음과 같은 시각화 원칙에 따라 차트를 표현합니다.

#### **4.1. 극점 표현 (주요/잠정적 극점의 시각적 구분)**

두 가지 신뢰도 등급의 극점은 명확히 구분되어야 합니다. 이를 위해 색상, 모양, 채움 여부 등을 달리하여 시각적 위계질서를 표현합니다.

- **주요 극점 (Major Extremum)**: 가장 신뢰도 높은 추세 전환점으로, 눈에 잘 띄는 채워진 마커로 표시합니다.
    
    - **주요 고점 (Major Peak)**: 강한 하락 반전을 암시하는 **채워진 아래 방향 삼각형 (▼)** 등으로 표현합니다.
        
    - **주요 저점 (Major Valley)**: 강한 상승 반전을 암시하는 **채워진 위 방향 삼각형 (▲)** 등으로 표현합니다.
        
- **잠정적 극점 (Provisional Extremum)**: 중간 규모의 전환점으로, 주요 극점과 구분되는 보조적인 마커로 표시합니다.
    
    - **잠정적 고점 (Provisional Peak)**: 주요 고점보다 옅은 색의 채워진 원(●) 또는 속이 빈 마커(▽) 등으로 표현합니다.
        
    - **잠정적 저점 (Provisional Valley)**: 주요 저점보다 옅은 색의 채워진 원(●) 또는 속이 빈 마커(△) 등으로 표현합니다.
        

#### **4.2. 추세 표현 (지그재그 라인 및 배경 음영)**

추세의 흐름과 구간을 명확하게 보여주기 위해 선과 배경색을 사용합니다.

- **지그재그 라인 (ZigZag Line)**: 탐지된 **모든 극점(주요 및 잠정적)을 시간순으로 연결**하여 가격의 파동을 시각화합니다. 이 선은 최종적으로 확정된 추세의 방향에 따라 색상이 동적으로 변경됩니다. (예: 상승-녹색, 하락-빨간색, 횡보-회색)
    
- **추세 배경 음영**: 최종 추세 판단 로직에 의해 확정된 추세 구간을 시각적으로 강조하기 위해 차트 배경에 반투명한 색상을 적용합니다.
    
    - **상승 추세 구간**: 연한 녹색 배경
        
    - **하락 추세 구간**: 연한 붉은색 배경
        

---

### **5. 결론**

#### **5.1. 알고리즘의 강점 요약**

본 알고리즘은 기존 기술적 분석의 한계를 극복하기 위해 설계된 강력하고 체계적인 접근 방식입니다. 핵심 강점은 다음과 같습니다.

- **객관성 및 일관성**: 다우 이론과 명확한 상태 머신 규칙에 기반하여, 분석가의 주관적인 해석을 배제하고 일관된 기준으로 추세를 판단합니다.
    
- **실시간성**: 미래 데이터를 참조하지 않고 오직 과거와 현재의 가격 정보만을 사용하여, 실시간 매매 환경에서 왜곡 없이 동작합니다.
    
- **강건함 (Robustness)**: 상태 머신은 다양한 시장 상황에 체계적으로 대응하며, 신뢰도 모델(주요/잠정적 극점)은 미세한 노이즈와 거시적인 추세 구조를 구분하여 분석의 깊이를 더합니다.
    
- **범용성**: 특정 자산이나 타임프레임에 국한되지 않는 보편적인 가격 행동 원칙에 기반하여, 다양한 시장 환경에서 높은 적용 가능성을 가집니다.
    

#### **5.2. 향후 개선 방향**

알고리즘의 정확성과 신뢰도를 더욱 향상시키기 위해 다음과 같은 방향으로 개선을 고려할 수 있습니다.

- **변동성 통합**: ATR(Average True Range)과 같은 변동성 지표를 도입하여, 시장 상황에 따라 극점 탐지의 민감도나 패턴 규칙의 임계값을 동적으로 조절할 수 있습니다.
    
- **거래량 분석 추가**: 다우 이론의 핵심 원칙 중 하나인 '추세는 거래량으로 확인된다'를 적용하여, 주요 극점 돌파 시 거래량을 함께 분석하면 신호의 신뢰도를 한층 더 높일 수 있습니다.
    
- **파라미터 최적화**: 상태 머신의 기준 횟수(`n_criteria`), 패턴 규칙의 임계값 등 주요 파라미터들을 각 시장과 타임프레임의 특성에 맞게 통계적으로 최적화하는 연구를 진행할 수 있습니다.
    
- **고급 패턴 확장**: 현재의 정교한 극점 탐지 엔진은 H&S, DT/DB 패턴뿐만 아니라, 플래그(Flag), 트라이앵글(Triangle) 등 더 복잡한 차트 패턴을 인식하는 기반으로 확장될 수 있습니다.