# ChartInsight Studio Backend 수동 디버깅 가이드

이 문서는 WSL2 환경에서 FastAPI Backend를 디버깅하는 완전한 단계별 가이드입니다.

## 🎯 목표
- Backend 코드에 브레이크포인트를 설정하고 실시간으로 디버깅
- Frontend나 curl 요청을 통해 API 호출 시 코드 실행을 단계별로 추적
- Debug Console에서 변수 값 확인 및 코드 실행

## 📋 사전 준비사항

### 1. 프로젝트 루트 디렉토리 이동
```bash
cd ~/ChartInsight-Studio
pwd  # 현재 위치 확인: /home/jscho/ChartInsight-Studio 출력되어야 함
```

### 2. 필요한 Docker 컨테이너 실행
Backend 디버깅을 위해서는 PostgreSQL 데이터베이스가 필요합니다.

```bash
# 현재 실행 중인 컨테이너 확인
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# PostgreSQL 컨테이너 실행 (없는 경우)
docker compose up -d postgres-tradesmart

# 실행 확인 (postgres-tradesmart가 "Up" 상태여야 함)
docker ps | grep postgres-tradesmart
```

**예상 출력:**
```
eadbed7e7cfb   postgres:15   "docker-entrypoint.s…"   Up 2 minutes (healthy)   0.0.0.0:5433->5432/tcp   postgres-tradesmart
```

## 🚀 디버깅 시작하기

### 3. 환경 변수 설정
Backend가 데이터베이스에 연결하기 위한 환경 변수를 설정합니다.

```bash
# 환경 변수 설정
export DATABASE_URL="postgresql+psycopg2://tradesmart_db:1234@localhost:5433/tradesmart_db"

# 설정 확인
echo $DATABASE_URL
# 출력: postgresql+psycopg2://tradesmart_db:1234@localhost:5433/tradesmart_db
```

### 4. Backend 디렉토리로 이동
```bash
cd backend
pwd  # 현재 위치 확인: /home/jscho/ChartInsight-Studio/backend
```

### 5. 가상환경 및 debugpy 확인
```bash
# 가상환경 Python 실행 파일 확인
ls -la venv/bin/python*

# debugpy 설치 확인
./venv/bin/pip show debugpy | head -5
```

**예상 출력:**
```
Name: debugpy
Version: 1.8.16
Summary: An implementation of the Debug Adapter Protocol for Python
```

### 6. Backend 서버를 디버깅 모드로 실행
이 명령어는 서버를 실행 모드로 실행합니다. 

```bash
uvicorn app.main:app --reload --port 8000
```

이 명령어는 서버를 디버깅 모드로 시작하고 디버거 연결을 기다립니다.

```bash
./venv/bin/python -Xfrozen_modules=off -m debugpy --listen 5680 --wait-for-client -m uvicorn app.main:app --host 127.0.0.1 --port 8000
```

**명령어 설명:**
- `-Xfrozen_modules=off`: 디버깅을 위한 Python 최적화 비활성화
- `-m debugpy --listen 5680`: 5680 포트에서 디버거 연결 대기
- `--wait-for-client`: 디버거가 연결될 때까지 서버 시작을 대기
- `-m uvicorn app.main:app`: FastAPI 앱 실행

**실행 후 상태:** 터미널이 멈춘 상태로 대기합니다. 이것이 정상입니다!

### 7. 디버거 연결 상태 확인 (새 터미널에서)
**새 터미널 탭/창을 열고** 다음 명령어를 실행합니다:

```bash
# 5680 포트가 LISTEN 상태인지 확인
ss -ltn | grep 5680
```

**예상 출력:**
```
LISTEN 0      4096       127.0.0.1:5680       0.0.0.0:*
```
이 출력이 나오면 디버거가 연결을 기다리고 있는 것입니다.

### 8. VS Code/Cursor에서 디버거 연결

1. **Run and Debug 패널 열기**
   - 왼쪽 사이드바의 벌레 🐛 아이콘 클릭
   - 또는 `Ctrl+Shift+D` 단축키 사용

2. **디버거 구성 선택**
   - 상단 드롭다운에서 **"Attach to Backend (5680)"** 선택

3. **디버거 연결**
   - **F5** 키를 누르거나 초록색 ▶️ 버튼 클릭
   - 2초 후 디버거가 연결됩니다

4. **연결 성공 확인**
   - 첫 번째 터미널에서 다음과 같은 메시지가 나타나면 성공:
   ```
   INFO:     Started server process [77715]
   INFO:     Waiting for application startup.
   INFO:     Application startup complete.
   INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
   ```

## 🔍 디버깅 테스트

### 9. 브레이크포인트 설정
1. `backend/app/routers/pattern_analysis.py` 파일 열기
2. 983번 줄 `if _is_korean_stock_code(symbol):` 부분 찾기
3. 줄 번호 왼쪽을 클릭하여 빨간 점(브레이크포인트) 생성

### 10. Frontend 실행 (새 터미널에서)
```bash
cd ~/ChartInsight-Studio/frontend
npm run dev
```

**실행 확인:**
- 브라우저에서 `http://localhost:3000` 접속
- Trading Radar 페이지로 이동
- 한국 주식 탭에서 종목 선택 (예: 삼성전자 005930)

### 11. API 직접 호출 테스트 (대안)
```bash
curl "http://localhost:8000/api/v1/pattern-analysis/trading-radar-data?symbol=005930&timeframe=5m&chart_type=candlestick&period=auto"
```

## 🎮 디버깅 컨트롤

브레이크포인트에서 실행이 멈췄을 때 사용할 수 있는 키:

- **F5** (Continue): 다음 브레이크포인트까지 실행
- **F10** (Step Over): 현재 줄 실행 후 다음 줄로 이동
- **F11** (Step Into): 함수 호출이 있으면 함수 내부로 들어가기
- **Shift+F11** (Step Out): 현재 함수에서 빠져나오기

### Debug Console 사용법
브레이크포인트에서 멈췄을 때 하단의 Debug Console에서 Python 코드 실행 가능:

```python
# 현재 변수 값 확인
symbol
timeframe
period

# 함수 테스트
_is_korean_stock_code(symbol)
_is_korean_stock_code("AAPL")

# DB 연결 상태 확인
db
```

## 🔧 트러블슈팅

### 포트 충돌 문제
```bash
# 8000번 포트 사용 프로세스 확인
ss -ltn | grep 8000

# uvicorn 프로세스 종료
pkill -f uvicorn

# debugpy 프로세스 종료
pkill -f debugpy
```

### 환경 변수 문제
```bash
# 현재 환경 변수 확인
env | grep DATABASE_URL

# 다시 설정
export DATABASE_URL="postgresql+psycopg2://tradesmart_db:1234@localhost:5433/tradesmart_db"
```

### PostgreSQL 연결 문제
```bash
# 컨테이너 상태 확인
docker ps | grep postgres-tradesmart

# 컨테이너 재시작
docker restart postgres-tradesmart
```

## 🛑 디버깅 종료

1. **서버 중지**: 첫 번째 터미널에서 `Ctrl+C`
2. **디버거 연결 해제**: VS Code/Cursor에서 빨간 정사각형 ⏹️ 버튼 클릭
3. **Frontend 중지**: Frontend 터미널에서 `Ctrl+C`

## 📝 참고사항

- 이 방법은 **수동 디버깅**으로, 매번 터미널에서 명령어를 실행해야 합니다
- 자동 디버깅(Run & Debug 버튼 한 번으로 실행)을 원한다면 `launch.json`과 `tasks.json` 설정을 점검해야 합니다
- 디버깅 중에는 API 응답이 느려질 수 있습니다 (정상적인 현상)

---
*마지막 업데이트: 2025년 1월*