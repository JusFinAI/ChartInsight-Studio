
### 1. 개요

이 문서는 **가격 데이터만을 활용한 실시간 추세 분석 알고리즘**을 설명합니다. 이 알고리즘은 시장의 **주요 고점과 저점**을 탐지하여 **상승 추세(Uptrend)**, **하락 추세(Downtrend)**, **횡보 추세(Sideways)**를 판단합니다. **종목이나 타임프레임에 독립적**으로 작동하며, **추가적인 기술적 지표나 미래 데이터 없이** 오직 가격의 움직임 자체만으로 추세를 분석합니다. 이를 통해 트레이더는 시장의 방향성을 객관적으로 파악하고 실시간으로 의사결정을 내릴 수 있습니다.

**수정 포인트**:

- **JS Peak-Valley**나 **Secondary Peak-Valley** 같은 특수 용어를 제거하고, **주요 고점과 저점**이라는 일반적인 표현으로 대체했습니다.
- **상승 추세**, **하락 추세**, **횡보 추세**는 트레이딩에서 널리 사용되는 용어이므로 그대로 유지했습니다.

---

### 2. 알고리즘의 목적

이 알고리즘은 금융 시장에서 **가격 데이터(Open, High, Low, Close)**만을 사용해 **실시간으로 추세를 판단**하고, 중요한 **고점(Peak)**과 **저점(Valley)**을 탐지하는 것을 목표로 합니다. 기존의 분석 도구들은 종종 특정 종목이나 타임프레임에 맞춰 최적화되거나 미래 데이터를 필요로 해서 실시간성과 범용성이 부족한 단점이 있었습니다. 이 알고리즘은 이러한 문제를 해결하기 위해 설계되었으며, 다음과 같은 핵심 특징을 갖고 있습니다:

- **추가적인 기술적 지표나 미래 데이터 없이 작동**: 가격의 움직임 자체만으로 추세를 분석해 **실시간성**을 극대화합니다.
- **종목과 타임프레임에 독립적**: 주식, 암호화폐, 외환 등 다양한 자산과 1분봉, 일봉 등 여러 시간 단위에서 일관되게 적용됩니다.
- **객관적인 추세 판단**: **주요 전환점**을 식별하고, 이를 통해 **상승 추세**, **하락 추세**, **횡보 추세**를 명확히 구분합니다.

특히, 이 알고리즘은 추세 내에서 발생하는 **중간 전환점**을 포착하여 단순한 고점과 저점 분석으로는 놓칠 수 있는 세부적인 추세 변화를 감지합니다. 이를 통해 트레이더는 시장의 방향성을 더 정교하게 분석할 수 있습니다.

## 3. 핵심 개념과 용어

- **상태(State)**: 가격의 움직임을 분석하여 다음 네 가지 상태로 관리합니다.
  - **State 0 (추세 없음)**: 명확한 방향성이 없거나 추세가 리셋된 상태
  - **State 1 (추세 가설)**: 추세의 방향이 나타날 가능성을 최초로 감지한 상태
  - **State 2 (추세 형성)**: 추세가 한 방향으로 실제로 움직이기 시작한 상태
  - **State 3 (추세 확정)**: 가격이 명확하게 한 방향으로 진행 중인 상태

- **추세 카운트**: 같은 방향으로 움직이는 캔들의 연속 횟수입니다. 설정된 기준(기본값 2)을 초과하면 추세가 확정됩니다.

- **내부봉**: 현재 캔들의 가격 범위(High-Low)가 이전 캔들의 가격 범위 안에 완전히 포함된 상태입니다. 내부봉이 감지되면 현재 상태를 유지하며 추세 판단을 잠시 미룹니다.

- **리셋 High/Low**: 추세가 종료되었을 때 저장되는 High/Low로, 새 추세 탐색을 위한 기준점입니다.

- **기준 High/Low**: 상태 변화 판단을 위한 직전 캔들의 High/Low입니다.

- **추세(Trend)**: 가격의 방향성을 나타내며, 다음 세 가지로 정의됩니다.
  - **Uptrend (상승 추세)**: Higher High(HH)와 Higher Low(HL)가 지속적으로 형성되는 상태
  - **Downtrend (하락 추세)**: Lower High(LH)와 Lower Low(LL)가 지속적으로 형성되는 상태
  - **Sideways (추세 없음)**: 명확한 방향성이 없는 상태

* ***JS Peak/Valley**: **주요 추세 전환점.** State 3에서 해당 추세의 종료 조건(기준선 돌파 + 반대 방향 캔들)이 만족될 때 등록되는 가장 중요도가 높은 고점(Peak)과 저점(Valley)입니다.

    - **JS Peak**: State 3(up) 상승 추세가 종료될 때, 해당 추세 구간 내에서 기록된 **가장 높은 고점 (`highest_high`)**.
    - **JS Valley**: State 3(down) 하락 추세가 종료될 때, 해당 추세 구간 내에서 기록된 **가장 낮은 저점 (`lowest_low`)**.

* ***Secondary Peak/Valley**: **중간 규모의 추세 전환점.** JS Peak/Valley 사이에 나타나거나 추세 진행 중에 발생하는 상대적인 고점과 저점입니다. 이들은 추세의 세부 구조를 파악하고, 특히 **추세 시작 조건(HL/LH 형성)을 판단하는 데 중요한 역할**을 합니다. V4.0 알고리즘에서는 다음 **두 가지 방식**으로 탐지 및 등록됩니다. _(세부 내용은 4.(12) 참조)_

    - **방식 1 (JS 등록 시 탐색):** JS Peak/Valley가 등록될 때, 그 이전 JS 극점과의 사이에서 탐색됩니다.
    - **방식 2 (실시간 돌파 시 탐색):** 이전 JS Peak/Valley를 돌파하는 이벤트 발생 시, HL/LH 조건 만족 여부를 확인하며 즉시 탐색 및 등록됩니다.

## 4. 알고리즘 작동 원리 (상태 전이 로직)

### (1) 초기 상태 판단 (첫 번째 캔들)

- **상승시:**
  > `(Close > Open)`
  → 첫 캔들이 양봉이면 상승 추세 가설(State 1)을 형성합니다.

- **하락시:**
  > `(Close < Open)`
  → 첫 캔들이 음봉이면 하락 추세 가설(State 1)을 형성합니다.

- **방향성 없음:**
  > `(Close = Open)`
  → 첫 캔들이 도지형이면 추세 없음(State 0) 상태를 유지합니다.

---

### (2) 내부봉 처리 로직

모든 상태 전이 판단 전에 내부봉 여부를 먼저 확인합니다:

> `현재 High ≤ 기준 High and 현재 Low ≥ 기준 Low`

→ 내부봉으로 판단되면 현재 상태를 유지하고 다음 캔들로 넘어갑니다. 이는 내부봉이 추세의 방향성을 판단하기에 충분한 정보를 제공하지 않기 때문입니다.

---

### (3) State 0에서 State 1 또는 State 2로 전환

**State 1로의 전환 (추세 가설 형성):**

- **상승시:**
  > `(High > 리셋 High) and (Close > 직전 Open)`
  → 가격이 이전 고점을 돌파하면서 종가가 상승 압력을 보이면 상승 추세 가능성을 탐색합니다.

- **하락시:**
  > `(Low < 리셋 Low) and (Close < 직전 Open)`
  → 가격이 이전 저점을 하회하면서 종가가 하락 압력을 보이면 하락 추세 가능성을 탐색합니다.

**State 2로의 전환 (즉각적인 추세 형성):**

- **상승시:**
  > `(High > 리셋 High) and (Low ≥ 직전 Low) and (Close > 직전 Open)`
  → 리셋 상태에서 고점을 돌파하며 동시에 저점이 안정적이면 즉시 상승 추세 형성을 확정합니다.

- **하락시:**
  > `(Low < 리셋 Low) and (High ≤ 직전 High) and (Close < 직전 Open)`
  → 리셋 상태에서 저점을 하락 돌파하며 동시에 고점이 제한적이면 즉시 하락 추세 형성을 확정합니다.

---
### (4) State 1에서 State 2로의 변화 (추세 가설 → 추세 형성)

- **상승시:**
    
    > `(High > 직전 High) and (현재 Close > 직전 Close)` → 고점이 이전 기준 고점(`reference_high`)을 넘어서고 **현재 종가가 직전 캔들의 종가보다 높으면**, 추세가 상승으로 명확히 형성되기 시작했다고 판단합니다. 저점이 일시적으로 직전 저점(`reference_low`)을 하회하더라도 종가가 상승 마감하면 조건을 만족할 수 있습니다.
    
- **하락시:**
    
    > `(Low < 직전 Low) and (현재 Close < 직전 Close)` → 저점이 이전 기준 저점(`reference_low`)보다 낮아지고 **현재 종가가 직전 캔들의 종가보다 낮으면**, 추세가 하락으로 명확히 형성되기 시작했다고 판단합니다. 고점이 일시적으로 직전 고점(`reference_high`)을 상회하더라도 종가가 하락 마감하면 조건을 만족할 수 있습니다.

---

### (5) State 1에서 State 3으로 즉시 이동 (강한 추세)

- **상승시:**
  > `(abs(현재 종가 - 직전 종가) > 직전 캔들의 고점과 저점 차이) and (현재 종가 > 현재 시가) and (현재 종가 > 직전 종가)`
  → 가격이 직전 캔들의 범위를 벗어나는 강력한 상승 움직임을 보이고, 캔들의 방향성도 상승으로 일치하면 즉시 상승 추세를 확정합니다.

- **하락시:**
  > `(abs(현재 종가 - 직전 종가) > 직전 캔들의 고점과 저점 차이) and (현재 종가 < 현재 시가) and (현재 종가 < 직전 종가)`
  → 가격이 직전 캔들 범위를 벗어나 강력한 하락 움직임을 보이고, 캔들의 방향성도 하락으로 일치하면 즉시 하락 추세를 확정합니다.

---

### (6) State 1에서 추세 가설 취소 (리셋으로 전환)

추세 가설(State 1) 상태에서 추세 형성(State 2)으로 진행되지 못하고, 명확한 반대 방향 추세 가설(State 1 반대 방향)로도 전환되지 않을 때 State 0으로 리셋됩니다.

- **상승 추세 가설 → 리셋:**
    
    > 상승 추세 형성 조건(4.4)인 `(High > 직전 High and Close > 직전 Close)`를 만족하지 못하고, 동시에 하락 추세 가설 전환 조건(4.7)도 만족하지 못할 때. 예를 들어, 고점 돌파에 실패하거나(`High ≤ 직전 High`), **종가가 직전 종가보다 상승하지 못하는**(`Close ≤ 직전 Close`) 경우 등이 해당될 수 있습니다.
    
- **하락 추세 가설 → 리셋:**
    
    > 하락 추세 형성 조건(4.4)인 `(Low < 직전 Low and Close < 직전 Close)`를 만족하지 못하고, 동시에 상승 추세 가설 전환 조건(4.7)도 만족하지 못할 때. 예를 들어, 저점 하회에 실패하거나(`Low ≥ 직전 Low`), **종가가 직전 종가보다 하락하지 못하는**(`Close ≥ 직전 Close`) 경우 등이 해당될 수 있습니다.

---

### (7) State 1에서 반대 방향 추세 가설로 전환

**상승 추세 가설 → 하락 추세 가설:**
> `(Low < 직전 Low) and (Close < 직전 Open)`
→ 상승 추세 가설 조건이 깨지며 하락 조건을 만족하면 하락 추세 가설로 전환합니다.

**하락 추세 가설 → 상승 추세 가설:**
> `(High > 직전 High) and (Close > 직전 Open)`
→ 하락 추세 가설 조건이 깨지며 상승 조건을 만족하면 상승 추세 가설로 전환합니다.

---

### (8) State 2에서 State 3으로 추세 확정

- **상승 추세:**
    
    > State 2 상승 추세 지속 조건인 `(High > 직전 High) and (현재 Close > 직전 Close)`를 만족하는 캔들이 **`n_criteria`(기준값) 횟수 이상 연속**으로 나타나면 상승 추세가 확정(State 3 up)되었다고 판단합니다.
    
- **하락 추세:**
    
    > State 2 하락 추세 지속 조건인 `(Low < 직전 Low) and (현재 Close < 직전 Close)`를 만족하는 캔들이 **`n_criteria`(기준값) 횟수 이상 연속**으로 나타나면 하락 추세가 확정(State 3 down)되었다고 판단합니다.

---

### (9) State 2에서 State 1로 방향 전환

**상승 추세 → 하락 추세 가설:**
> `(Low < 직전 Low) and (Close < 직전 Open)`
→ 상승 추세 형성 중 저점이 하락하고 종가가 하락 압력을 보이면 하락 추세 가설로 즉시 전환합니다.

**하락 추세 → 상승 추세 가설:**
> `(High > 직전 High) and (Close > 직전 Open)`
→ 하락 추세 형성 중 고점이 상승하고 종가가 상승 압력을 보이면 상승 추세 가설로 즉시 전환합니다.

---

### (10) State 2에서 State 0으로 리셋 (추세 형성 취소)

**State 2에서 추세가 확정(State 3)되지 못하고, 명확한 반대 방향 추세 가설(State 1 반대 방향)로도 전환되지 않을 때 State 0으로 리셋됩니다.

- **상승 추세 형성 → 리셋:**
    
    > State 2 상승 추세 지속 조건인 `(High > 직전 High and Close > 직전 Close)`를 만족하지 못하고, 동시에 하락 추세 가설 전환 조건(4.9)도 만족하지 못할 때 추세 형성을 취소하고 리셋 상태로 전환합니다. 예를 들어, 고점 갱신에 실패하거나 종가가 직전 종가보다 상승하지 못하는 경우가 해당됩니다. **단순히 저점(Low)이 직전 기준 저점(reference_low)보다 낮아졌다는 이유만으로는 리셋되지 않을 수 있습니다.**
    
- **하락 추세 형성 → 리셋:**
    
    > State 2 하락 추세 지속 조건인 `(Low < 직전 Low and Close < 직전 Close)`를 만족하지 못하고, 동시에 상승 추세 가설 전환 조건(4.9)도 만족하지 못할 때 추세 형성을 취소하고 리셋 상태로 전환합니다. 예를 들어, 저점 갱신에 실패하거나 종가가 직전 종가보다 하락하지 못하는 경우가 해당됩니다. **단순히 고점(High)이 직전 기준 고점(reference_high)보다 높아졌다는 이유만으로는 리셋되지 않을 수 있습니다.**

---

### (11) ### State 3: 추세 확정 및 JS Peak/Valley 등록

- **State 3 진입 및 극점 추적:** State 2에서 `n_criteria` 충족 시 State 3 진입. 상승 시 `highest_high` 추적, 하락 시 `lowest_low` 추적.
- **JS Peak/Valley 등록 조건 (State 3 종료):**
    - **JS Peak 등록 (상승 추세 종료):** State 3(up) 상태에서, 현재 캔들이 **음봉(`Close < Open`)** 이면서 **종가가 기준 저점(`reference_low`)을 하회**할 때. 등록되는 값은 추적해온 `highest_high`. 이후 State 1(down)으로 전환.
    - **JS Valley 등록 (하락 추세 종료):** State 3(down) 상태에서, 현재 캔들이 **양봉(`Close > Open`)** 이면서 **종가가 기준 고점(`reference_high`)을 상회**할 때. 등록되는 값은 추적해온 `lowest_low`. 이후 State 1(up)으로 전환.

### (12) Secondary Peak/Valley 탐색 및 등록 (V020 최종 로직 상세 반영)

알고리즘은 추세의 세부 구조 파악 및 실시간성 향상을 위해 다음 **두 가지 뚜렷한 메커니즘**을 통해 Secondary Peak/Valley를 탐색하고 등록합니다. 두 방식 모두 등록 전에 **기존 JS 및 Secondary 극점과의 인덱스 중복을 확인**하여 동일한 지점이 중복 등록되는 것을 방지합니다.

**방식 1: JS Peak/Valley 등록 시점에서의 후행적 탐색 (기존 방식 유지)**

- **트리거:** `register_js_peak` 또는 `register_js_valley` 함수가 호출될 때 (즉, JS 극점이 등록될 때).
- **탐색 구간 및 대상:**
    - JS Peak 등록 시: 새로 등록된 JS Peak와 시간상 바로 **이전 JS Peak** 사이 구간에서 **가장 낮은 저점(Low)** (Secondary Valley 후보).
    - JS Valley 등록 시: 새로 등록된 JS Valley와 시간상 바로 **이전 JS Valley** 사이 구간에서 **가장 높은 고점(High)** (Secondary Peak 후보).
- **등록 조건:**
    - Secondary Valley 후보: 해당 저점 값이 **양쪽 JS Peak 값보다 모두 낮아야** 등록.
    - Secondary Peak 후보: 해당 고점 값이 **양쪽 JS Valley 값보다 모두 높아야** 등록.
- **목적:** 주요 추세 전환 사이에 발생했던 가장 유의미한 반대 방향 극점을 식별하여 추세 구조를 파악합니다.

**방식 2: 실시간 돌파 이벤트 발생 시점에서의 선행적 탐색 (V020 최종 로직)**

- **트리거 및 확인 시점:** `process_candle` 함수 내에서 **매 캔들마다** 다음의 상승 돌파 및 하락 돌파 조건을 **독립적으로 확인**합니다. (즉, 가장 최근 JS 극점 타입에 의존하지 않음).
- **상승 돌파 확인 및 처리:**
    1. **기준 Peak 확인:** `_get_last_extremum('peak')` 함수를 통해 **가장 최근의 Peak (JS 또는 Secondary)** 를 찾습니다 (`latest_peak`).
    2. **돌파 조건 검사:** `latest_peak`가 존재할 경우, 현재 캔들이 **① 양봉(`Close > Open`)** 이고 **② 종가(`Close`)가 `latest_peak`의 값보다 높은지** 확인합니다.
    3. **돌파 시 실행:** 조건 만족 시,
        - Secondary Valley 탐색: `latest_peak`의 인덱스부터 현재 캔들 인덱스까지 구간에서 **가장 낮은 저점(`sec_valley_value`)**을 찾습니다.
        - **HL 조건 확인:** `_get_extremum_before(latest_peak['index'], 'valley')` 함수로 `latest_peak` **이전의 마지막 Valley**(`prev_valley_before_peak`)를 찾고, `sec_valley_value > prev_valley_before_peak['value']` 인지 (즉, **Higher Low 형성** 여부) 확인합니다.
        - **등록:** HL 조건 만족 및 중복 없을 시, 찾은 저점을 **Secondary Valley로 즉시 등록**합니다.
- **하락 돌파 확인 및 처리:**
    1. **기준 Valley 확인:** `_get_last_extremum('valley')` 함수를 통해 **가장 최근의 Valley (JS 또는 Secondary)** 를 찾습니다 (`latest_valley`).
    2. **돌파 조건 검사:** `latest_valley`가 존재할 경우, 현재 캔들이 **① 음봉(`Close < Open`)** 이고 **② 종가(`Close`)가 `latest_valley`의 값보다 낮은지** 확인합니다.
    3. **돌파 시 실행:** 조건 만족 시,
        - Secondary Peak 탐색: `latest_valley`의 인덱스부터 현재 캔들 인덱스까지 구간에서 **가장 높은 고점(`sec_peak_value`)**을 찾습니다.
        - **LH 조건 확인:** `_get_extremum_before(latest_valley['index'], 'peak')` 함수로 `latest_valley` **이전의 마지막 Peak**(`prev_peak_before_valley`)를 찾고, `sec_peak_value < prev_peak_before_valley['value']` 인지 (즉, **Lower High 형성** 여부) 확인합니다.
        - **등록:** LH 조건 만족 및 중복 없을 시, 찾은 고점을 **Secondary Peak로 즉시 등록**합니다.
- **목적:** 주요 저항/지지선 돌파 시 HL/LH 형성 여부를 즉시 확인하여 관련 Secondary를 선행 등록함으로써, 후속 추세 판단 함수(`check_...start`)가 더 빠르게 추세 시작을 인지할 수 있도록 정보를 제공하여 **실시간성을 향상**시킵니다.

---
## 5. 추세 판단 기준 (V020 로직 상세 반영)

최종 시장 추세(`market_trend`)는 JS 및 Secondary Peak/Valley 정보를 종합하여 다음과 같이 결정됩니다. 추세 시작 판단은 `market_trend`가 "Sideways"일 때만 시도되며, 추세 지속/종료 판단은 해당 추세가 진행 중일 때 수행됩니다.

### (1) 상승 추세 (Uptrend)

- **시작 조건 (`check_uptrend_start`):** 다음 **두 가지 조건**을 **동시에 만족**해야 합니다.
    1. **Higher Low (HL) 형성:** 모든 Valley(JS+Secondary) 중 가장 최근 2개를 비교했을 때, 최근 Valley의 저점이 이전 Valley의 저점보다 높아야 합니다.
    2. **직전 Peak 돌파:** 현재 캔들의 종가(Close)가 모든 Peak(JS+Secondary) 중 가장 최근 Peak의 고점 값보다 높아야 합니다.
- **지속 조건:** `market_trend`가 "Uptrend"이고 아래 종료 조건이 만족되지 않은 상태.
- **종료 조건 (`check_uptrend_continuation`):** 현재 캔들의 종가(Close)가, **상승 추세를 형성하거나 지지한 가장 최근의 Valley (JS 또는 Secondary)의 저점 값보다 낮아지면** "Sideways"로 전환됩니다.

### (2) 하락 추세 (Downtrend)

- **시작 조건 (`check_downtrend_start`):** 다음 **두 가지 조건**을 **동시에 만족**해야 합니다.
    1. **Lower High (LH) 형성:** 모든 Peak(JS+Secondary) 중 가장 최근 2개를 비교했을 때, 최근 Peak의 고점이 이전 Peak의 고점보다 낮아야 합니다.
    2. **직전 Valley 돌파:** 현재 캔들의 종가(Close)가 모든 Valley(JS+Secondary) 중 가장 최근 Valley의 저점 값보다 낮아야 합니다.
- **지속 조건:** `market_trend`가 "Downtrend"이고 아래 종료 조건이 만족되지 않은 상태.
- **종료 조건 (`check_downtrend_continuation`):** 현재 캔들의 종가(Close)가, **하락 추세를 형성하거나 저항으로 작용한 가장 최근의 Peak (JS 또는 Secondary)의 고점 값보다 높아지면** "Sideways"로 전환됩니다.

### (3) 횡보 추세 (Sideways)

- Uptrend 또는 Downtrend의 종료 조건 만족 시 "Sideways" 상태가 됩니다.
- "Sideways" 상태에서 Uptrend 또는 Downtrend의 시작 조건 만족 시 해당 추세 상태로 전환됩니다.

---
## 6. 시각화 (색상 변경 반영)

알고리즘의 분석 결과를 직관적으로 이해하고 검증하기 위해 Plotly 라이브러리를 활용하여 인터랙티브 차트를 생성합니다.

### (1) 시각화 요소

- **캔들스틱 및 거래량:**
    
    - 캔들 차트는 일반적인 금융 차트 표준에 따라 **양봉은 녹색, 음봉은 빨간색**으로 표시됩니다.
    - 하단의 거래량 막대(Bar) 차트 역시 해당 캔들의 등락에 맞춰 **상승 시 녹색, 하락 시 빨간색**으로 표시되어 가격 움직임과의 연관성을 쉽게 파악할 수 있도록 합니다.
- **Peak와 Valley 마커:**
    
    - 알고리즘이 탐지한 주요 전환점과 중간 전환점을 명확히 구분하여 표시합니다.
    - **JS Peak (주요 고점):** 하락 반전을 나타내는 **빨간색 아래 방향 삼각형(▼)**으로 표시됩니다.
    - **JS Valley (주요 저점):** 상승 반전을 나타내는 **녹색 위 방향 삼각형(▲)**으로 표시됩니다. (색상 통일성 제안 반영)
    - **Secondary Peak (중간 고점):** **빨간색 속이 빈 아래 방향 삼각형(▽)** 또는 다른 스타일로 표시하여 JS Peak와 구분합니다.
    
    - **Secondary Valley (중간 저점):** **녹색 속이 빈 위 방향 삼각형(△)** 또는 다른 스타일로 표시하여 JS Valley와 구분합니다. (색상 통일성 제안 반영)
    - _(참고: 마커의 정확한 스타일(크기, 채움 여부 등)은 코드에서 조정 가능합니다.)_
- **추세선 (ZigZag):**
    
    - 탐지된 **모든 JS 및 Secondary 극점들을 시간순으로 연결**하여 가격의 파동 움직임을 보여줍니다.
    
    - 각 선분의 색상은 해당 구간의 **최종 `market_trend` 상태**에 따라 동적으로 변경됩니다.
        - **상승 추세 (Uptrend):** **녹색** 선
        - **하락 추세 (Downtrend):** **빨간색** 선
        - **횡보 추세 (Sideways):** **회색** 또는 검은색 선
- **추세 구간 배경:**
    
    - 최종적으로 확정된 추세 구간을 시각적으로 강조하기 위해 배경색을 적용합니다.
    - **상승 추세 (Uptrend) 구간:** **연한 녹색** 배경
    - **하락 추세 (Downtrend) 구간:** **연한 빨간색** 배경
    - **횡보 추세 (Sideways) 구간:** 배경색을 적용하지 않거나 매우 연한 회색으로 표시합니다.

### (2) 시각화 구현 방식

- **라이브러리:** Python의 Plotly 라이브러리를 사용하여 인터랙티브하고 상세한 차트를 생성합니다.
- **캔들스틱:** `go.Candlestick` 객체를 사용하며, `increasing_line_color='green'`, `decreasing_line_color='red'` 파라미터를 설정하여 색상을 지정합니다.
- **거래량:** `go.Bar` 객체를 사용하며, 캔들 색상 규칙에 따라 `marker_color`를 동적으로 설정합니다.
- **극점 마커:** `go.Scatter` 객체(mode='markers+text')를 사용하여 각 극점 유형별로 다른 마커 심볼, 색상, 크기 등을 지정하여 표시합니다.
- **추세선 (ZigZag):** 극점들을 순차적으로 연결하는 `go.Scatter` 객체(mode='lines')를 사용합니다. 각 선분(segment)을 그릴 때, 해당 구간의 마지막 캔들 시점에서의 `market_trend` 상태를 확인하여 `line=dict(color=...)` 속성을 설정합니다.
- **추세 배경:** `trend_periods` 리스트에 기록된 추세 시작/종료 날짜와 타입을 기반으로, `go.Scatter` 객체의 `fill='toself'` 옵션 또는 `fig.add_shape(type='rect')`를 사용하여 특정 영역에 반투명한 배경색을 적용합니다.

### (3) 디버깅 필요 사항 (기존 내용 유지)

- `trend_periods` 리스트에 추세 구간의 시작(`start`)과 종료(`end`) 날짜가 정확히 기록되는지 지속적인 확인이 필요합니다 (배경색 표시 범위 정확성).
- 추세선(ZigZag) 색상이 모든 구간에서 해당 구간의 최종 `market_trend` 상태를 올바르게 반영하는지 검증이 필요합니다.
- 대량의 데이터를 처리할 때 Plotly 차트의 렌더링 성능 저하 문제가 발생할 수 있으므로, 필요시 성능 최적화 방안을 고려해야 합니다 (예: 데이터 샘플링, `Scattergl` 사용 등).

---

## 7. 개선 방향

- **변동성을 고려한 추가 검증**:
  - 변동성 지표(예: ATR)를 활용하여 JS Peak/Valley 및 Secondary Peak/Valley 검출의 신뢰도를 높일 수 있음.

- **장기 내부봉 시 리셋 조건 보완**:
  - 연속적인 내부봉이 발생할 경우 추세 판단을 보류하는 대신, 일정 기간 후 리셋 조건을 강화.

- **다양한 자산과 타임프레임에 대한 추가적인 검증**:
  - 더 많은 자산과 타임프레임에서 알고리즘의 일관성을 테스트.

- **추세 강도에 따른 피벗 포인트 가중치 도입**:
  - 추세의 강도를 평가하여 JS Peak/Valley와 Secondary Peak/Valley의 중요도를 가중치로 부여.

- **Secondary Peak/Valley 활용 강화**:
  - Secondary Peak/Valley를 활용하여 더 세밀한 추세 전환 감지 및 패턴 분석 가능.

- **시각화 개선**:
  - `trend_periods`의 `end` 날짜 설정 로직을 강화하여 배경 표시 누락 문제 해결.
  - 추세 선 색상이 모든 구간에서 의도대로 표시되도록 디버깅 (특히 Secondary Peak/Valley를 포함한 구간).
  - Plotly 차트의 성능 최적화를 통해 대량 데이터 처리 속도 개선.

---

## 8. 결론

이 알고리즘은 가격 데이터만을 활용하여 JS Peak/Valley와 Secondary Peak/Valley를 실시간으로 탐지하며, 추세 판단 기준을 명확히 정의하여 상승 추세와 하락 추세를 체계적으로 관리합니다. Secondary Peak/Valley를 추가로 검출함으로써 추세 내 세부적인 변화를 더 정밀하게 분석할 수 있습니다. 또한, Plotly를 활용한 인터랙티브 시각화를 통해 사용자에게 직관적인 결과를 제공합니다. 향후 개선 방향을 통해 알고리즘의 정확성과 시각화 품질을 더욱 향상시킬 수 있을 것입니다.

---

### **수정 사항 요약**

1. **Secondary Peak/Valley 관련 내용 추가**:
   - **3. 핵심 개념과 용어** 섹션에 Secondary Peak/Valley의 정의를 추가했습니다.
   - **4. 알고리즘 작동 원리**의 "(11) State 3에서 최고/최저점 추적" 섹션에 Secondary Peak/Valley 검출 로직을 추가했습니다.
   - **5. 추세 판단 기준**에서 Secondary Peak/Valley를 추세 시작, 지속, 종료 조건에 포함시켰습니다.
   - **6. 시각화**에서 Secondary Peak/Valley의 표시 방식과 활용 사례(예: 세 번째 Secondary Valley → 네 번째 JS Peak 구간)를 추가했습니다.
   - **7. 개선 방향**에 Secondary Peak/Valley 활용 강화를 추가했습니다.

2. **기존 내용 유지 및 보완**:
   - 추세 판단 기준(상승/하락 추세의 시작, 지속, 종료 조건)과 시각화 섹션은 기존 내용을 유지하되, Secondary Peak/Valley를 반영하여 보완했습니다.

---


### 쟁점 

handle_state_3 → Js Peak  등록 기준 기준에 '음봉' 조건 을 넣을지 말지 (즉 도지나 양봉은 배제 할지)
handle_state_3 → Js Valley  등록 기준 기준에 '양봉' 조건 을 넣을지 말지(즉 도지나 음봉은 배제 할지)


