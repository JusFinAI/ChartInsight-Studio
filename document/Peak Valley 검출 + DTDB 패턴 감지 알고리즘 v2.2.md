
## 1. 개요

### 1.1 알고리즘의 목적 

본 문서는 Peak Valley 검출 알고리즘 V3.4에서 감지된 고점(Peak)과 저점(Valley)을 기반으로 가격 차트에서 주요 반전 패턴인 Double Bottom(DB)과 Double Top(DT) 패턴을 자동으로 감지하는 알고리즘을 정의합니다. 이 알고리즘의 핵심 목표는 다음과 같습니다:

- **객관적 패턴 검출**: "성공률 높은" 패턴을 선별적으로 찾는 것이 아니라, Price Action 관점에서 객관적이고 합리적으로 DT/DB 패턴을 기계적으로 검출하는 것에 중점을 둡니다.
    
- **실시간 감지**: 미래 데이터 없이 현재 시점까지의 정보만으로 패턴을 식별하여 실시간 트레이딩 의사결정 지원이 가능합니다.
    
- **범용성 확보**: 주식, 암호화폐, 외환 등 다양한 금융 자산과 일봉, 시간봉, 분봉 등 여러 타임프레임에 일관되게 적용 가능합니다.
    
- **확장성 제공**: 검출된 모든 패턴을 기반으로 추후 성공/실패 여부를 정의하고, 통계적 분석 및 머신러닝 모델을 통한 성공 확률 예측 기능으로 확장할 수 있습니다.
    

이 알고리즘은 트레이더들이 차트에서 인식하는 패턴 형성 과정을 체계화하여, 주관적 판단 없이도 일관된 기준으로 DT/DB 패턴을 감지합니다. 이는 특정 패턴만을 선별적으로 찾아내는 것이 아니라, 모든 유효한 패턴을 객관적으로 식별하는 데 초점을 맞추고 있습니다.

### 1.2 패턴의 기본 개념과 주요 용어

- **Double Bottom (DB)**: 하락 추세에서 비슷한 가격대에 두 개의 저점(Valley)이 형성된 후 반등하는 패턴으로, 추세 반전의 신호
- **Double Top (DT)**: 상승 추세에서 비슷한 가격대에 두 개의 고점(Peak)이 형성된 후 하락하는 패턴으로, 추세 반전의 신호

- **실제 Valley 캔들** : Peak Valley 검출 알고리즘에서 감지된 Valley의 실제 저점(Low)을 형성한 캔들
- **Valley 확정 캔들** : 실제 Valley 캔들 이후, Valley를 확정짓고 등록하도록 하는 양봉 캔들(Close > 직전 캔들의 High).
- **실제 Peak 캔들**:   Peak Valley 검출 알고리즘에서 감지된 Peak의 실제 고점(High)을 형성한 캔들.
- **Peak 확정 캔들** : 실제 Peak 캔들 이후, Peak를 확정짓고 등록하도록 하는 음봉 캔들(Close < 직전 캔들의 Low).

### 1.3 Peak Valley 검출 알고리즘과의 연계

이 알고리즘은 Peak Valley 검출 알고리즘 V3.21에서 제공하는 추세 상태(State)와 극점 정보를 활용합니다:

- **State 3 (추세 확정)**: 가격이 명확하게 한 방향으로 진행 중인 상태에서 Peak 또는 Valley가 감지되면 패턴 탐색 시작
- **Peak/Valley 감지 시점**: 실제 극점 발생 시점과 감지 시점 사이에 지연이 존재할 수 있음을 고려한 설계

### 1.4 패턴 감지의 주요 도전 과제

- **지연 감지 문제**: 극점은 이후 가격 움직임을 통해 확정되므로 실제 발생 시점과 감지 시점 사이에 지연 발생
- **잘못된 신호 구분**: 진정한 반전 패턴과 일시적 가격 변동 구분 필요
- **다양한 시장 환경**: 변동성 높은 시장과 안정적 시장에서 모두 작동해야 함

## 2. 알고리즘 핵심 개념

### 2.1 상태(Stage) 정의

패턴 감지는 다음 네 단계로 진행됩니다:

1. **Pullback**: 첫 번째 극점 감지 후 반대 방향으로의 가격 움직임 단계
2. **Reentry**: Pullback 후 다시 원래 방향으로 가격이 움직이며 지지/저항대에 재진입하는 단계
3. **Reentry confirmation**: 두 번째 극점 형성 후 패턴 완성을 위한 확인 단계
4. **Completed**: 패턴이 완전히 완성되어 트레이딩 신호가 생성된 단계

### **2.2 지지/저항 밴드(Support/Resistance Band)**

Double Bottom(DB) 또는 Double Top(DT) 패턴을 검출하기 위해서는, 패턴 첫 번째 극점(Valley 또는 Peak)이 확정된 뒤 이를 기준으로 지지/저항 밴드를 설정해야 합니다. 이 밴드는 두 번째 극점(Valley 또는 Peak)을 판단하는 기준선 역할을 하며, 밴드의 상하 범위를 어디로 둘 것인지에 따라 패턴 인식 범위가 달라집니다.

본 알고리즘에서는 다음과 같은 세 가지 옵션을 고려하되, 실무 적용 시에는 “옵션 2”를 기본값(Default)으로 권장합니다. 옵션 1과 옵션 3은 특정 시장 상황(고변동성, 과도한 스파이크 존재 등)에 대응하기 위한 보조적 대안으로 제시됩니다.

---

 **(1) 옵션 1: 확정(확인) 캔들의 극단값 사용**

- DB (Support Band)  
  - band.low = 실제 Valley 캔들의 Low  
  - band.high = Valley 확정(양봉) 캔들의 High  

- DT (Resistance Band)  
  - band.high = 실제 Peak 캔들의 High  
  - band.low = Peak 확정(음봉) 캔들의 Low  

    **특징 및 사용 예시**  
    - 밴드 범위가 가장 넓기 때문에, 변형된 패턴(예: 오른쪽 Valley가 더 높게 형성되는 짝꿍데이 등)도 적극적으로 인식함  
    - 고변동성 시장에서 오른쪽(또는 두 번째) 극점이 다소 크게 출렁여도 DB/DT 패턴으로 간주 가능  
    - 단점: 잘못된 신호(false positives)가 증가할 가능성이 높음  

**(2) 옵션 2 (기본값): 확정(확인) 캔들의 중심값((Open+Close)/2) 사용** 

- DB (Support Band)  
  - band.low = 실제 Valley 캔들의 Low  
  - band.high = Valley 확정(양봉) 캔들의 (Open + Close) / 2  

- DT (Resistance Band)  
  - band.high = 실제 Peak 캔들의 High  
  - band.low = Peak 확정(음봉) 캔들의 (Open + Close) / 2  

    **특징 및 사용 예시**  
    - “몸통 중심((Open + Close)/2)”은 Price Action 관점에서 시장 참여자들의 균형 지점을 반영  
    - 과도한 위/아래 꼬리(wick)에 흔들리지 않으며, 전형적인 DB/DT 형태를 비교적 엄격하게 필터링  
    - 실시간 분석과 과거 데이터 검증 시에도 노이즈 대비 신호(시장의 합의점)를 합리적으로 측정  
    - 중간 수준의 밴드 범위로, 기본 설정으로 활용하기 적합  

**(3) 옵션 3: 실제 극점 캔들 자체(High-Low)만 사용** 

- DB (Support Band)  
  - band.low = 실제 Valley 캔들의 Low  
  - band.high = 실제 Valley 캔들의 High  

- DT (Resistance Band)  
  - band.high = 실제 Peak 캔들의 High  
  - band.low = 실제 Peak 캔들의 Low  

    **특징 및 사용 예시**  
    - 밴드 범위가 가장 좁아, 극도로 엄격한 인식 기준을 적용  
    - 왼쪽/오른쪽 극점이 거의 동일 선상에서만 DB/DT로 간주되므로, 놓칠 수 있는 패턴이 많음  
    - 고정밀 패턴 검출이 필요한 특수 전략(예: 좁은 가격 변동 구간에서의 반전)에 사용 가능  

**(4) 밴드 선택 가이드 및 주의사항*

1. **시장 상황ㆍ트레이딩 스타일별 권장 사항**
    
    - 옵션 2(기본값): 변동성이 적정한 시장에서 “몸통 중심값”으로 밴드를 설정해 전형적인 DB/DT를 안정적으로 포착.
    - 옵션 1: 고변동성 시장에서 범위를 넓혀 변형 패턴까지 폭넓게 인식. 잘못된 시그널 위험은 증가.
    - 옵션 3: 극도로 엄격한 교과서적 패턴만 추출해 정확도는 높으나 검출 빈도는 낮음. 
    
2. **밴드 설정 시 주의할 점**
    
    - 넓게 잡으면(옵션 1) 검출 빈도는 높지만 오탐도 증가.
    - 좁게 잡으면(옵션 3) 검출 빈도는 낮지만 엄격도↑.
    - 몸통 중심값((Open+Close)/2)은 Price Action에서 합의점을 반영해 노이즈 영향 축소.
    - 밴드 설정 차이는 추후 통계ㆍML 분석 결과에도 영향을 미치므로 시장 환경에 맞게 선택해야 함.

### 2.3 직전 극점(Straight Extremum)

- **Straight Peak (DB)**: 첫 번째 Valley 이전에 발생한 가장 최근의 Peak
  - 패턴 유효성 검증에 활용: 가격이 이 Peak를 상회하면 DB 패턴 무효화

- **Straight Valley (DT)**: 첫 번째 Peak 이전에 발생한 가장 최근의 Valley
  - 패턴 유효성 검증에 활용: 가격이 이 Valley를 하회하면 DT 패턴 무효화

### 2.4 패턴 완성 조건

- **DB 완성 조건**: 두 번째 Valley 형성 후 연속된 상승 확인
- **DT 완성 조건**: 두 번째 Peak 형성 후 연속된 하락 확인
- **유효성 지속 검증**: 모든 단계에서 지속적으로 패턴 유효성 확인

## 3. Double Bottom (DB) 패턴 탐지

### 3.1 패턴 정의와 흐름

Double Bottom은 하락 추세가 종료되고 상승 반전이 일어나는 것을 나타내는 패턴으로, 다음과 같은 흐름을 가집니다:

- 첫 번째 Valley 형성: State 3(하락 추세 확정)에서 Valley 감지
- Pullback: Valley 이후 연속된 상승 움직임 확인
- Reentry: Pullback 후 가격이 다시 첫 번째 Valley 근처로 하락
- Reentry Confirmation: 두 번째 Valley 형성 후 상승 반등 확인
- Completed: 패턴 완성 및 상승 추세 시작

### 3.2 세부 단계별 조건 (DB)

#### 3.2.1 첫 번째 Valley 감지 및 초기화

- **감지 조건**: State 3(하락 추세 확정)에서 Valley 등록 시 DB 감지기 활성화

- **Support Band 설정** (기본값: 옵션 2)
  - band.low: 실제 Valley 캔들의 Low
  - band.high: Valley 확정(양봉) 캔들의 (Open + Close)/2
  - 이 밴드는 두 번째 Valley 형성 가능성을 판단하는 기준이 됩니다

- **직전 Peak 조회**
  - 현재 Valley 이전의 가장 최근 Peak 조회
  - 이 Peak는 패턴 유효성 검증에 활용됨

- **초기 단계 설정**: Stage = "Pullback"으로 설정, 패턴 감지 시작

#### 3.2.2 Pullback 단계

- **목적**: Valley 이후 상승 반등 확인을 통해 첫 번째 저점의 유효성 검증

- **완료 조건**
  - Valley 확정(양봉) 캔들 이후, 양봉(Close > Open)이고, 종가가 Valley 확정(양봉) 캔들의 종가보다 높은 캔들이 발생한 경우
  - Pullback 단계에서는 여러 개의 음봉이 발생할 수 있으며, 이는 허용됩니다. 단, 리셋 조건이 발생하지 않는 한 Pullback 진행 중으로 간주
  - 조건 충족 시 Stage = "Reentry"로 전환

- **리셋 조건**
  - 가격이 Support Band 하단 붕괴: Close < Support Band.low
  - 가격이 직전 Peak 상회: Close > Straight Peak
  - 리셋 발생 시 이 패턴 감지기는 비활성화됨

- **구현 시 유의사항**
  - 각 캔들마다 먼저 리셋 조건을 검사한 후, 완료 조건을 확인
  - 중간에 음봉이 나타나도 패턴 감지는 계속 진행되며, 이는 실제 시장에서 반등이 항상 직선적으로 일어나지 않음을 반영
  - 최종적으로 Valley 확정 캔들의 종가보다 높은 양봉이 발생해야만 다음 단계로 진행

- **지연 감지 대응**
  - Valley가 지연 감지되더라도, 감지 즉시 직전 캔들과 현재 캔들을 비교하여 이미 Pullback이 진행 중인지 확인
  - 이를 통해 패턴을 놓치지 않고 감지 가능

#### 3.2.3 Reentry 단계

- **목적**: Pullback 후 가격이 다시 첫 번째 저점 근처로 하락하는지 확인

- **완료 조건**
  - 캔들의 저점(Low)이 Support Band 상단(High) 이하로 내려가는 경우
  - 조건 충족 시 Stage = "Reentry Confirmation"으로 전환

- **리셋 조건**
  - 가격이 Support Band 하단 붕괴: Close < Support Band.low
  - 가격이 직전 Peak 상회: Close > Straight Peak
  - 이 조건들은 패턴의 유효성을 지속적으로 검증하기 위함

#### 3.2.4 Reentry Confirmation 단계

- **목적**: 두 번째 저점 형성 후 상승세 확인을 통한 패턴 완성 검증

- **완료 조건**
  - 현재 캔들이 양봉(Close > Open)이고:
    - 직전 캔들도 양봉인 경우: 현재 종가 > 직전 종가
    - 직전 캔들이 음봉인 경우: 현재 종가 > 직전 시가
  - 이는 두 번째 Valley 형성 후 명확한 상승 반전이 일어났음을 확인하는 과정
  - 조건 충족 시 Stage = "Completed"로 전환

- **리셋 조건**
  - 가격이 Support Band 하단 붕괴: Close < Support Band.low
  - 가격이 직전 Peak 상회: Close > Straight Peak
  - 패턴 완성 직전까지도 유효성 검증이 계속됨

#### 3.2.5 Completed 단계

- **의미**: Double Bottom 패턴이 완전히 완성되었으며, 상승 추세 시작 예상
- **처리**: 패턴 완성 기록 및 감지기 비활성화
- **활용**: 이 시점에서 매수 신호 생성 또는 통계 분석을 위한 데이터 수집 가능

### 3.3 DB 패턴 감지의 핵심 요소

- **Support Band 역할**
  - 첫 번째 Valley의 지지 영역을 정의하고, 두 번째 Valley 형성 가능 범위를 결정
  - 옵션 2(기본값)는 실제 Valley의 Low와 확정 캔들 몸통 중심값으로 밴드를 구성해 전형적인 DB 패턴을 인식
  - 옵션 1은 더 넓은 밴드로 변형된 패턴(오른쪽 Valley가 약간 높은 형태 등)까지 포착 가능

- **단계별 진행과 유효성 검증**
  - 각 단계마다 리셋 조건을 먼저 확인하여 패턴 무효화 여부를 즉시 판단
  - 완료 조건은 Price Action 관점에서 실제 트레이더들이 인식하는 패턴 형성 과정과 일치하도록 설계
  - 지연 감지 문제를 해결하기 위해 각 단계에서 직전 캔들과 현재 캔들을 함께 분석

- **실시간 적용과 확장성**
  - 미래 데이터 없이 현재 시점까지의 정보만으로 패턴을 감지
  - 감지된 패턴은 추후 통계 분석이나 머신러닝 모델의 입력 데이터로 활용 가능
  - 성공/실패 여부를 추적하여 시장 환경별 패턴 신뢰도 분석에 활용할 수 있음

## 4. Double Top (DT) 패턴 탐지

### 4.1 패턴 정의와 흐름

Double Top은 상승 추세가 종료되고 하락 반전이 일어나는 것을 나타내는 패턴으로, 다음과 같은 흐름을 가집니다:

- 첫 번째 Peak 형성: State 3(상승 추세 확정)에서 Peak 감지
- Pullback: Peak 이후 연속된 하락 움직임 확인
- Reentry: Pullback 후 가격이 다시 첫 번째 Peak 근처로 상승
- Reentry Confirmation: 두 번째 Peak 형성 후 하락 확인
- Completed: 패턴 완성 및 하락 추세 시작

### 4.2 세부 단계별 조건 (DT)

#### 4.2.1 첫 번째 Peak 감지 및 초기화

- **감지 조건**: State 3(상승 추세 확정)에서 Peak 등록 시 DT 감지기 활성화

- **Resistance Band 설정** (기본값: 옵션 2)
  - band.high: 실제 Peak 캔들의 High
  - band.low: Peak 확정(음봉) 캔들의 (Open + Close)/2
  - 이 밴드는 두 번째 Peak 형성 가능성을 판단하는 기준이 됩니다

- **직전 Valley 조회**
  - 현재 Peak 이전의 가장 최근 Valley 조회
  - 이 Valley는 패턴 유효성 검증에 활용됨

- **초기 단계 설정**: Stage = "Pullback"으로 설정, 패턴 감지 시작

#### 4.2.2 Pullback 단계

- **목적**: Peak 이후 하락 조정 확인을 통해 첫 번째 고점의 유효성 검증

- **완료 조건**
  - Peak 확정(음봉) 캔들 이후, 음봉(Close < Open)이고, 종가가 Peak 확정(음봉) 캔들의 종가보다 낮은 캔들이 발생하는 경우
  - Pullback 단계에서는 여러 개의 음봉이 발생할 수 있으며, 이는 허용됩니다. 단, 리셋 조건이 발생하지 않는 한 Pullback 진행 중으로 간주 
 
  - 조건 충족 시 Stage = "Reentry"로 전환

- **리셋 조건**
  - 가격이 Resistance Band 상단 돌파: Close > Resistance Band.high
  - 가격이 직전 Valley 하회: Close < Straight Valley
  - 리셋 발생 시 이 패턴 감지기는 비활성화됨

- **구현 시 유의사항**
  - 각 캔들마다 먼저 리셋 조건을 검사한 후, 완료 조건을 확인
  - 중간에 양봉이 나타나도 패턴 감지는 계속 진행되며, 이는 실제 시장에서 조정이 항상 직선적으로 일어나지 않음을 반영
  - 최종적으로 Peak 확정 캔들의 종가보다 낮은 음봉이 발생해야만 다음 단계로 진행

- **지연 감지 대응**
  - Peak가 지연 감지되더라도, 감지 즉시 직전 캔들과 현재 캔들을 비교하여 이미 Pullback이 진행 중인지 확인
  - 이를 통해 패턴을 놓치지 않고 감지 가능

#### 4.2.3 Reentry 단계

- **목적**: Pullback 후 가격이 다시 첫 번째 고점 근처로 상승하는지 확인

- **완료 조건**
  - 캔들의 고점(High)이 Resistance Band 하단(Low) 이상으로 올라가는 경우
  - 조건 충족 시 Stage = "Reentry Confirmation"으로 전환

- **리셋 조건**
  - 가격이 Resistance Band 상단 돌파: Close > Resistance Band.high
  - 가격이 직전 Valley 하회: Close < Straight Valley
  - 이 조건들은 패턴의 유효성을 지속적으로 검증하기 위함

#### 4.2.4 Reentry Confirmation 단계

- **목적**: 두 번째 고점 형성 후 하락세 확인을 통한 패턴 완성 검증

- **완료 조건**
  - 현재 캔들이 음봉(Close < Open)이고:
    - 직전 캔들도 음봉인 경우: 현재 종가 < 직전 종가
    - 직전 캔들이 양봉인 경우: 현재 종가 < 직전 시가
  - 이는 두 번째 Peak 형성 후 명확한 하락 반전이 일어났음을 확인하는 과정
  - 조건 충족 시 Stage = "Completed"로 전환

- **리셋 조건**
  - 가격이 Resistance Band 상단 돌파: Close > Resistance Band.high
  - 가격이 직전 Valley 하회: Close < Straight Valley
  - 패턴 완성 직전까지도 유효성 검증이 계속됨

#### 4.2.5 Completed 단계

- **의미**: Double Top 패턴이 완전히 완성되었으며, 하락 추세 시작 예상
- **처리**: 패턴 완성 기록 및 감지기 비활성화
- **활용**: 이 시점에서 매도 신호 생성 또는 통계 분석을 위한 데이터 수집 가능

### 4.3 DT 패턴 감지의 핵심 요소

- **Resistance Band 역할**
  - 첫 번째 Peak의 저항 영역을 정의하고, 두 번째 Peak 형성 가능 범위를 결정
  - 옵션 2(기본값)는 실제 Peak의 High와 확정 캔들 몸통 중심값으로 밴드를 구성해 전형적인 DT 패턴을 인식
  - 옵션 1은 더 넓은 밴드로 변형된 패턴(오른쪽 Peak가 약간 낮은 형태 등)까지 포착 가능

- **단계별 진행과 유효성 검증**
  - 각 단계마다 리셋 조건을 먼저 확인하여 패턴 무효화 여부를 즉시 판단
  - 완료 조건은 Price Action 관점에서 실제 트레이더들이 인식하는 패턴 형성 과정과 일치하도록 설계
  - 지연 감지 문제를 해결하기 위해 각 단계에서 직전 캔들과 현재 캔들을 함께 분석

- **실시간 적용과 확장성**
  - 미래 데이터 없이 현재 시점까지의 정보만으로 패턴을 감지
  - 감지된 패턴은 추후 통계 분석이나 머신러닝 모델의 입력 데이터로 활용 가능
  - 성공/실패 여부를 추적하여 시장 환경별 패턴 신뢰도 분석에 활용할 수 있음
## 5. 패턴 감지 핵심 원칙과 고려사항

### 5.1 패턴 감지의 핵심 원칙

- **객관성 유지**:
    
    - 모든 패턴 감지 과정은 명확하게 정의된 규칙에 따라 진행
    - 주관적 판단을 배제하고 일관된 기준으로 패턴을 감지함으로써 재현성 확보
- **단계적 검증**:
    
    - Pullback → Reentry → Reentry Confirmation → Completed 순서로 단계적 검증
    - 각 단계마다 리셋 조건을 먼저 확인하여 패턴 무효화 여부를 즉시 판단
    - 이를 통해 잘못된 패턴 감지를 최소화하고 신뢰도 높은 패턴만 추출
- **실시간 감지 최적화**:
    
    - 지연 감지 문제를 해결하기 위해 Peak/Valley 확정 즉시 이전 캔들들을 소급 분석
    - 이를 통해 실시간 트레이딩에서도 패턴을 놓치지 않고 포착 가능

### 5.2 패턴 감지에 영향을 미치는 요소

- **Support/Resistance Band 설정**:
    
    - 옵션 2(기본값)는 캔들 몸통 중심값을 사용해 전형적인 패턴 형태를 포착
    - 옵션 1은 더 넓은 밴드로 변형된 패턴(예: 오른쪽 Valley가 더 높은 형태)까지 감지
    - 옵션 3은 가장 엄격한 기준으로, 교과서적인 패턴만을 인식
- **시장 변동성**:
    
    - 고변동성 시장에서는 옵션 1이 더 많은 패턴을 포착할 수 있으나 오탐지 위험도 증가
    - 저변동성 시장에서는 옵션 2나 3이 더 안정적인 결과를 제공할 수 있음
- **타임프레임 선택**:
    
    - 상위 타임프레임에서 감지된 패턴이 일반적으로 더 신뢰도가 높음
    - 하위 타임프레임에서는 패턴 수는 많으나 노이즈도 증가하는 경향이 있음

## 6. 머신러닝 적용 방안 (아이디어)

### 6.1 패턴 성공/실패 정의 추가

- **DB 패턴 성공**: 패턴 완성 후 가격이 첫 번째 Peak 상향 돌파
- **DT 패턴 성공**: 패턴 완성 후 가격이 첫 번째 Valley 하향 돌파
- 이러한 정의를 추가하여 패턴의 실제 예측력 분석 가능

### 6.2 머신러닝을 통한 패턴 성공 확률 예측

패턴 감지 알고리즘을 통해 식별된 DB/DT 패턴은 머신러닝 모델의 입력 데이터로 활용하여 해당 패턴의 성공 확률을 예측할 수 있습니다. 이를 위해 다음과 같은 특성(Feature) 추출 방법을 구현할 수 있습니다:

**6.2.1 패턴 구조적 특성**

- **깊이(Depth)**: 두 극점 사이의 가격 변동 폭
  - 계산 방법: `(첫 번째 Valley와 중간 Peak 사이의 가격 차이) / 첫 번째 Valley 가격`
  - 예: DB 패턴에서 첫 번째 Valley가 100, 중간 반등 Peak가 110이면 깊이는 0.1(10%)

- **폭(Width)**: 패턴 형성에 소요된 시간적 범위
  - 계산 방법: `두 번째 Valley(또는 Peak) 인덱스 - 첫 번째 Valley(또는 Peak) 인덱스`
  - 정규화: 전체 데이터셋 길이에 대한 비율로 표현하여 다양한 타임프레임에 적용 가능

- **대칭성(Symmetry)**: 두 Valley/Peak의 가격 및 시간적 대칭 정도
  - 가격 대칭: `1 - |첫 번째 Valley 가격 - 두 번째 Valley 가격| / 중간 Peak 가격`
  - 시간 대칭: `min(T1, T2) / max(T1, T2)` (T1: 첫 Valley→중간 Peak, T2: 중간 Peak→두 번째 Valley)
  - 완벽한 대칭일수록 1에 가까운 값

- **형태 비율(Shape Ratio)**: 패턴의 높이 대 폭 비율
  - 계산 방법: `패턴 깊이 / 패턴 폭`
  - 이 비율은 패턴의 "날카로움" 정도를 나타냄

**6.2.2 가격 역학적 특성**

- **볼륨 프로파일(Volume Profile)**:
  - 첫 번째 Valley/Peak에서의 볼륨
  - 두 번째 Valley/Peak에서의 볼륨
  - 볼륨 비율: `두 번째 극점 볼륨 / 첫 번째 극점 볼륨`
  - 이상적인 DB/DT 패턴에서는 두 번째 극점에서 볼륨이 감소하는 경향

- **모멘텀 다이버전스(Momentum Divergence)**:
  - RSI, MACD 등 모멘텀 지표의 두 극점 간 차이
  - 계산 방법: `두 번째 극점의 지표값 - 첫 번째 극점의 지표값`
  - 다이버전스 존재 여부를 이진값(0/1)으로 표현

- **가격 변동성(Price Volatility)**:
  - 패턴 형성 기간 동안의 ATR(Average True Range)
  - 전체 시장 변동성 대비 패턴 내 변동성 비율

- **추세 강도(Trend Strength)**:
  - 패턴 이전 N 캔들의 방향성 일관성
  - ADX(Average Directional Index)와 같은 추세 강도 지표 값

**6.2.3. 시장 맥락적 특성**

- **시장 레짐(Market Regime)**:
  - 현재 시장 상태(강세장, 약세장, 횡보장)를 분류하는 이진/범주형 변수
  - VIX 또는 자산별 변동성 지표를 기반으로 한 시장 상태

- **타임프레임 일치성(Timeframe Alignment)**:
  - 상위 타임프레임에서의 추세 방향과 현재 패턴의 예상 방향 일치 여부
  - 예: 일봉에서 DB 패턴 발생 시 주봉 차트의 추세 방향 (일치:1, 불일치:0)

- **계절성 요인(Seasonality)**:
  - 요일, 월, 분기 등 시간적 요소를 범주형 변수로 인코딩
  - 특정 자산이 계절적 패턴을 보이는 경우 중요한 특성이 될 수 있음

- **지지/저항 밀집도(S/R Density)**:
  - 패턴 주변의 과거 지지/저항 수준 밀집도
  - 계산 방법: 패턴 가격 범위 내에 존재하는 과거 N일간의 주요 지지/저항 수준 개수

 **6.2.4. 패턴 확정 특성**

- **확정 신호 강도(Confirmation Signal Strength)**:
  - Reentry Confirmation 단계에서의 캔들 크기: `(종가 - 시가) / 시가`
  - 양봉/음봉의 크기가 클수록 신호 강도가 높음을 의미

- **돌파 속도(Breakout Velocity)**:
  - 패턴 완성 후 N 캔들 동안의 가격 변화율
  - 계산 방법: `(N 캔들 후 종가 - 패턴 완성 시점 종가) / 패턴 완성 시점 종가`

- **패턴 형성 속도(Formation Speed)**:
  - 전체 패턴 형성에 소요된 시간 대비 시장 평균 패턴 형성 시간
  - 정규화된 값으로 표현하여 비교 가능

### 6.3 머신러닝 모델 구현 방안

추출된 특성들을 활용하여 다음과 같은 머신러닝 접근법을 구현할 수 있습니다:

6.3.1 지도학습 모델(Supervised Learning)

- **분류 모델(Classification)**:
  - 목표 변수: 패턴 성공(1) 또는 실패(0)
  - 알고리즘: Random Forest, Gradient Boosting, SVM, 신경망 등
  - 출력: 패턴 성공 확률(0~1 사이 값)

- **회귀 모델(Regression)**:
  - 목표 변수: 패턴 완성 후 N 캔들 이내 최대 가격 변동 비율
  - 알고리즘: Linear Regression, Ridge/Lasso, Gradient Boosting Regressor 등
  - 출력: 예상 가격 변동 폭(%)

**6.3.2 앙상블 접근법(Ensemble Approach)**

- **다중 타임프레임 모델 결합**:
  - 각 타임프레임(1분봉, 5분봉, 일봉 등)별로 별도 모델 훈련
  - 각 모델의 예측을 가중 평균하여 최종 예측 생성
  - 가중치는 과거 성능 기반으로 동적 조정 가능

- **다양한 특성 세트 기반 모델 앙상블**:
  - 구조적 특성만 사용한 모델, 가격 역학 특성만 사용한 모델 등 다양한 모델 구성
  - 모델 다양성을 통한 예측 안정성 확보

**6.3.3 강화학습 통합(Reinforcement Learning Integration)**

- **패턴 기반 트레이딩 전략 최적화**:
  - 상태(State): 현재 감지된 패턴 단계 및 특성들
  - 행동(Action): 진입, 홀딩, 청산 등 트레이딩 결정
  - 보상(Reward): 실현 수익률
  - 알고리즘: DQN, PPO, A2C 등

- **리스크 관리 통합**:
  - 패턴별 최적 포지션 크기 및 손절선 위치 학습
  - 패턴 신뢰도에 따른 자본 배분 전략 최적화

### 6.4 실시간 구현 및 백테스팅 프레임워크

머신러닝 모델을 실제 트레이딩 환경에 통합하기 위한 프레임워크를 구축할 수 있습니다:

 **6.4.1 데이터 파이프라인**:
   - 실시간 가격 데이터 수집 및 전처리
   - 패턴 감지 알고리즘 실행
   - 감지된 패턴에 대한 특성 추출
   - 머신러닝 모델에 입력하여 성공 확률 예측

 **6.4.2 백테스팅 엔진**:
   - 과거 데이터에서 DB/DT 패턴 식별 및 특성 추출
   - 다양한 진입/청산 전략 시뮬레이션
   - 성과 지표 계산: 승률, 손익비, 최대 낙폭, 샤프 비율 등
   - 최적 파라미터 탐색을 위한 그리드/랜덤 서치 구현

**6.4.3실시간 모니터링 대시보드**:
   - 현재 감지 중인 패턴 시각화
   - 패턴별 성공 확률 및 예상 이익 표시
   - 모델 성능 지표 실시간 업데이트

### 6.5 지속적 학습 및 개선 메커니즘

패턴 감지 및 예측 시스템의 지속적인 개선을 위한 프로세스를 구축할 수 있습니다:

**6.5.1온라인 학습(Online Learning)**:
   - 새로운 패턴 데이터가 수집될 때마다 모델 점진적 업데이트
   - 시장 레짐 변화에 적응하는 동적 가중치 조정

**6.5.2 A/B 테스팅 프레임워크**:
   - 다양한 패턴 감지 옵션(밴드 설정 등) 동시 실행
   - 성능 지표 비교를 통한 최적 설정 자동 선택

**6.5.3 이상 감지(Anomaly Detection)**:
   - 모델 예측과 실제 결과 간 큰 차이가 발생하는 케이스 식별
   - 이러한 예외 케이스 분석을 통한 모델 개선 포인트 발견

이러한 확장된 머신러닝 프레임워크를 통해, 단순한 패턴 감지를 넘어서 각 패턴의 성공 확률을 정량적으로 평가하고, 리스크를 고려한 최적의 트레이딩 의사결정을 지원할 수 있습니다. 특히 시장 상황과 자산 특성에 따라 패턴의 신뢰도가 달라질 수 있으므로, 이러한 컨텍스트 정보를 포함한 다차원적 분석이 가능한 머신러닝 접근법은 전통적인 패턴 트레이딩의 한계를 크게 확장할 수 있습니다.






---
