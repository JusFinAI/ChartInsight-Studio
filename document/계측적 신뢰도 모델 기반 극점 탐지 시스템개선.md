네, 좋습니다. 함께 완성도 높은 로직을 개발하기 위한 사전 단계로 Small PRD(제품 요구사항 문서)를 작성하는 것은 매우 현명한 접근입니다. 우리가 논의한 내용을 기반으로, 각 파일을 어떻게 수정해야 할지에 대한 명확한 청사진을 작성해 드리겠습니다.

그리고 파일은 다시 제공해주시지 않아도 괜찮습니다. 지금까지의 대화 내용을 통해 현재 코드 구조를 충분히 파악하고 있습니다. 😊

---

## **PRD: '계층적 신뢰도 모델' 기반 극점 탐지 시스템 개선**

### 1. 개요 (Overview)

#### **1.1. 문제 정의**
현재 Secondary 극점 탐지 로직은 JS 극점 또는 Breakout에 의존하여, 패턴 인식에 필수적인 극점을 뒤늦게 발견하는 '심각한 지연' 문제를 야기한다. 이로 인해 H/S, IHS와 같은 복잡한 패턴의 탐지율이 저하되고 시스템의 실시간 반응성이 떨어진다.

#### **1.2. 해결 목표**
기존의 분리된 JS/Secondary 탐지 로직을 **'통합된 계층적 신뢰도 모델'**로 개편한다. 이를 통해 모든 극점을 일관된 기준하에 신속하게 탐지하고, 각 극점의 '신뢰도'를 계층적으로 관리함으로써 **탐지의 신속성과 안정성을 동시에 확보**한다.

---

### 2. 핵심 개념 정의 (Core Concept Definitions)

새로운 시스템은 극점을 3단계의 신뢰도 등급으로 관리한다.

* **1등급: 기본 극점 (Base Extremum)**
    * **정의**: N-Window 방식을 통해 식별된 가장 기본적인 국부적 고점/저점.
    * **역할**: 모든 극점 탐지의 시작점. 신뢰도가 낮아 직접적인 패턴 분석의 '시작점'으로는 사용되지 않으나, '잠정적 극점'을 확정하는 데 사용됨.

* **2등급: 잠정적 극점 (Provisional Extremum)**
    * **정의**: **1등급 극점**이 형성된 후, **더 낮은 고점(Peak의 경우) 또는 더 높은 저점(Valley의 경우)**이 나타났을 때 확정되는 극점.
    * **역할**: 패턴 분석을 시작할 수 있는 **최소한의 안정성을 확보한 극점.** `PatternManager`는 이 2등급 극점의 발생을 트리거로 H/S, IHS 등의 패턴 탐색을 시작한다.

* **3등급: 확정적 극점 (Confirmed Extremum)**
    * **정의**: 기존 로직과 같이, 의미 있는 추세의 실패(예: `JS Valley` → `JS Valley`)가 확인되었을 때, 그 사이에서 가장 중요했던 2등급 극점이 3등급으로 최종 승격된다. JS 극점 자체도 3등급으로 간주할 수 있다.
    * **역할**: 가장 높은 신뢰도를 가진 극점. 이 극점을 기반으로 형성된 패턴은 **'고신뢰도 패턴'**으로 분류된다.

---

### 3. 파일별 수정 내역 (File-by-File Modification Plan)

#### **3.1. `trend.py` - `TrendDetector` 클래스 (가장 많은 변경 필요)**

`TrendDetector`는 이제 단순 극점 탐지를 넘어, 극점의 '신뢰도' 상태를 관리하는 핵심적인 역할을 수행한다.

* **신규 상태 변수 추가**:
    * `self.secondary_search_state`: `IDLE`, `TRACKING_PEAK`, `TRACKING_VALLEY` 등의 상태를 관리하여 현재 '기본 극점'을 추적 중인지 여부를 확인.
    * `self.candidate_extremum`: 현재 추적 중인 최고/최저점 후보(1등급)를 저장.

* **`process_candle` 메서드 로직 변경**:
    * **(제거)**: 기존의 '돌파 기반' Secondary 탐지 로직을 완전히 제거한다.
    * **(추가)**: **N-Window 로직**을 매 캔들마다 실행하여 **1등급(Base) 극점**을 식별한다.
    * **(추가)**: `secondary_search_state`에 따라 다음 로직을 수행한다.
        * `IDLE` 상태에서 `JS Valley` 감지 시 → `TRACKING_PEAK` 상태로 전환.
        * `TRACKING_PEAK` 상태에서:
            1.  새로운 1등급 Peak를 계속 추적하며 `candidate_extremum`을 갱신한다.
            2.  만약 `candidate_extremum`보다 **낮은** 1등급 Peak가 나타나면, 기존 `candidate_extremum`을 **2등급(Provisional) 극점으로 최종 확정**하고 시스템에 등록(`newly_registered_...`)한다. 그 후 `candidate_extremum`을 초기화하고 계속 추적을 이어간다.

* **`register_js_...` 메서드 로직 변경**:
    * **(제거)**: 기존의 'JS 확정 시' Secondary 탐지 로직을 제거한다.
    * **(추가)**: `JS Valley` → `JS Valley` 흐름이 감지되었을 때, 그 사이에 등록되었던 **2등급 극점들을 3등급으로 승격**시키는 로직을 추가할 수 있다.

#### **3.2. `patterns.py` - `PatternManager` 클래스 (로직 트리거 변경)**

`PatternManager`는 이제 신뢰도 정보를 활용하여 패턴 탐색의 시점과 품질을 관리한다.

* **`check_for_hs_ihs_start` 메서드 트리거 변경**:
    * 이 함수는 이제 **2등급(Provisional) 극점**이 `TrendDetector`에 의해 등록되었을 때 호출되어야 한다. 이를 통해 훨씬 빠른 시점에 패턴 탐색을 시작할 수 있다.
    * 함수 내부 로직은 2등급 극점을 일반 극점과 동일하게 취급하여 패턴의 뼈대를 찾는다.

* **패턴 신뢰도 관리 (선택적 기능 확장)**:
    * `Detector` 생성 시, 해당 패턴이 어떤 등급의 극점들로 구성되었는지 정보를 함께 저장한다.
    * 최종 `completed_hs` 등의 결과에 `{ 'pattern': {...}, 'confidence': 'provisional' }` 와 같이 신뢰도 정보를 함께 기록하여, 사용자가 패턴의 품질을 구분할 수 있게 한다.

#### **3.3. `run_full_analysis.py` - `run_full_analysis` 함수 (구조적 변경 없음)**

* 이 파일은 전체 프로세스를 조립하는 역할이므로 **직접적인 로직 수정은 거의 필요 없다.**
* `detector.process_candle(...)`을 호출하면, 내부적으로 완전히 새로워진 `TrendDetector`가 동작하여 신뢰도 기반의 극점을 생성하고 `PatternManager`에 전달하는 흐름은 그대로 유지된다. 이는 좋은 아키텍처의 증거이다.
* 단, 최종 `analysis_results`를 구조화할 때, 위에서 제안한 '패턴 신뢰도' 정보를 포함하도록 수정할 수 있다.

---

### 4. 기대 효과 및 트레이드오프

* **기대 효과**:
    * **신속성**: `N+α`라는 훨씬 짧고 예측 가능한 시간 내에 패턴의 핵심 구성요소를 탐지.
    * **안정성**: 한번 확정된 '잠정적 극점'은 더 높은 극점이 나타나도 번복되지 않으므로, 패턴 탐지 과정의 안정성 대폭 향상.
    * **품질 관리**: 패턴의 신뢰도를 등급으로 관리하여, 분석의 깊이를 더함.
* **트레이드오프**:
    * 시스템은 한번 '잠정적(2등급)'으로 확정된 극점의 안정성을 우선시한다. 따라서 2등급 극점이 확정된 직후 만약 훨씬 더 높은 극점이 나타날 경우, 시스템은 이를 의도적으로 무시하고 기존 2등급 극점을 기반으로 분석을 이어간다. 이는 '최고점 추적'의 공격성을 '시스템의 안정성'과 맞바꾸는 합리적인 선택이다.

---

