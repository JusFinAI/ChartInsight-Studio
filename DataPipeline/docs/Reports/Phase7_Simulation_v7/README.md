# ğŸ“Š Phase 7: SIMULATION v7 ì•„í‚¤í…ì²˜

## ê°œìš”

**ì™„ë£Œì¼**: 2025-10-30  
**DataPipeline ë²„ì „**: v7.0  
**ì£¼ìš” ì„±ê³¼**: ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ê¸°ë°˜ SIMULATION ëª¨ë“œ ì™„ì„± ë° P2 ìŠ¤ì¼€ì¤„ë§ ì•ˆì •í™”

---

## ğŸ¯ Phase 7ì˜ ëª©í‘œ

SIMULATION ëª¨ë“œë¥¼ ì•ˆì •ì ì´ê³  í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜ë¡œ ì™„ì„±í•˜ì—¬, ê³¼ê±° ì‹œì  ë°ì´í„° ê¸°ë°˜ ë¶„ì„ ë° í…ŒìŠ¤íŠ¸ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

---

## ğŸ“š ë¬¸ì„œ

### 1. report_test_simulation_architechture.md

**ì‘ì„±ì¼**: 2025-10-30  
**ì¤‘ìš”ë„**: â­â­â­â­â­  
**ì£¼ì œ**: SIMULATION v7 ì•„í‚¤í…ì²˜ End-to-End í…ŒìŠ¤íŠ¸

#### ì£¼ìš” ë‚´ìš©

**1. ì•„í‚¤í…ì²˜ ì›ì¹™**
- **ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)**: ê° DAGëŠ” í•˜ë‚˜ì˜ ì±…ì„ë§Œ
  - `dag_initial_loader`: ë°ì´í„° ìˆ˜ì§‘/ì €ì¥
  - `dag_daily_batch`: ìˆœìˆ˜ ë¶„ì„
  - `dag_financials_update`: ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘

**2. SIMULATION ëª¨ë“œ êµ¬í˜„**
- **DB ìŠ¤ëƒ…ìƒ· ìƒì„±**: ê³¼ê±° ì‹œì  ë°ì´í„° ë³µì œ
  - `simulation.candles` â† `live.candles`
  - `simulation.financial_analysis_results` â† `live.financial_analysis_results`
- **ìˆœìˆ˜ ë¶„ì„**: `dag_daily_batch`ëŠ” ë°ì´í„° ë³€ê²½ ì—†ìŒ
- **ìë™ ê°ì§€**: `target_datetime`, `test_stock_codes` ìë™ ê²°ì •
- **Parquet ì œê±°**: DBë§Œ ì‚¬ìš©í•˜ì—¬ ë‹¨ìˆœí™”

**3. ê²€ì¦ ê²°ê³¼**
- LIVE ëª¨ë“œ ì´ˆê¸° ì ì¬ ì„±ê³µ (30ì¢…ëª©, 2024-01-01 ~ 2024-12-31)
- SIMULATION ìŠ¤ëƒ…ìƒ· ìƒì„± ê²€ì¦
- SIMULATION ë¶„ì„ ì‹¤í–‰ í™•ì¸ (2024-09-26)
- ë°ì´í„° ë¶„ë¦¬ ë° ë¬´ê²°ì„± ê²€ì¦ ì™„ë£Œ

---

### 2. report_ê³¼ê±°ì‹¤í–‰ìë™íŠ¸ë¦¬ê±°.md

**ì‘ì„±ì¼**: 2025-10-30  
**ì¤‘ìš”ë„**: â­â­â­â­  
**ì£¼ì œ**: P2 DAG ìŠ¤ì¼€ì¤„ë§ ì•ˆì •ì„± í™•ë³´

#### ì£¼ìš” ë‚´ìš©

**1. ë¬¸ì œ ì •ì˜**
- DAG unpause ì‹œ ê³¼ê±° ìŠ¤ì¼€ì¤„ ìë™ ì‹¤í–‰
- ì˜ë„í•˜ì§€ ì•Šì€ backfill ë°œìƒ
- ê°œë°œ ì¤‘ í…ŒìŠ¤íŠ¸ ë°©í•´

**2. ê·¼ë³¸ ì›ì¸**
- `start_date`ê°€ ê³¼ê±° (ì˜ˆ: 2024-01-01)
- Airflowì˜ "catchup" ë™ì‘
- ìŠ¤ì¼€ì¤„ ëˆ„ë½ ìë™ ë³´ì¶©

**3. í•´ê²° ë°©ì•ˆ**
```python
# Before
start_date=datetime(2024, 1, 1)  # âŒ ê³¼ê±° ë‚ ì§œ

# After
start_date=pendulum.now('Asia/Seoul').subtract(hours=1)  # âœ… ìµœê·¼ ë‚ ì§œ
```

**4. íš¨ê³¼**
- unpause í›„ ê³¼ê±° ì‹¤í–‰ ì—†ìŒ
- ë‹¤ìŒ ìŠ¤ì¼€ì¤„ë¶€í„°ë§Œ ì‹¤í–‰
- ê°œë°œ í™˜ê²½ ì•ˆì •í™”

---

### 3. SIMULATION_ëª¨ë“œ_ì¬ë¬´_ë°ì´í„°_ë³µì œ_ë¬¸ì œ_ë¶„ì„_ë³´ê³ ì„œ.md

**ì‘ì„±ì¼**: 2025-10-28  
**ì¤‘ìš”ë„**: â­â­â­â­  
**ì£¼ì œ**: SIMULATION ì¬ë¬´ ë°ì´í„° ë³µì œ ë²„ê·¸ í•´ê²°

#### ì£¼ìš” ë‚´ìš©

**1. ë¬¸ì œ**
- `simulation.financial_analysis_results` ë°ì´í„° ë³µì œ ì•ˆ ë¨
- ì¬ë¬´ ë¶„ì„ì´ ë¹„ì–´ìˆëŠ” ìƒíƒœë¡œ ì‹¤í–‰

**2. ê·¼ë³¸ ì›ì¸**
- SQLAlchemy subqueryì˜ `session.get_bind()` ë²„ê·¸
- `financial_analysis_results` í…Œì´ë¸”ë§Œ ì˜í–¥
- `candles` í…Œì´ë¸”ì€ ì •ìƒ ë™ì‘

**3. í•´ê²° ë°©ì•ˆ**
```python
# Before: SQLAlchemy ORM (ë²„ê·¸)
subquery = session.query(LiveFinancialAnalysisResult).filter(...)
session.execute(insert_stmt.from_select([...], subquery))  # âŒ

# After: Raw SQL (ì•ˆì •ì )
sql = """
    INSERT INTO simulation.financial_analysis_results
    SELECT * FROM live.financial_analysis_results
    WHERE analysis_date <= :target_date
"""
session.execute(text(sql), {"target_date": target_date})  # âœ…
```

**4. êµí›ˆ**
- ORMì˜ í•œê³„ ì¸ì‹
- ë³µì¡í•œ ì¿¼ë¦¬ëŠ” Raw SQL ê³ ë ¤
- ì² ì €í•œ ë°ì´í„° ê²€ì¦ í•„ìš”

**í˜„í™© ì½”ë©˜íŠ¸**: ì´ ë²„ê·¸ëŠ” ì™„ì „íˆ í•´ê²°ë˜ì—ˆìœ¼ë©°, í˜„ì¬ SIMULATION ëª¨ë“œì˜ ì¬ë¬´ ë°ì´í„° ìŠ¤ëƒ…ìƒ·ì€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.

---

## ğŸ† ì£¼ìš” ì„±ê³¼

### ì•„í‚¤í…ì²˜ ì™„ì„±ë„

```
âœ… ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì™„ë²½ êµ¬í˜„
âœ… LIVE/SIMULATION ì™„ì „ ë¶„ë¦¬
âœ… ìˆœìˆ˜ ë¶„ì„ DAG êµ¬í˜„
âœ… ìë™ íƒ€ê²Ÿ ê°ì§€
âœ… Parquet ì˜ì¡´ì„± ì œê±°
âœ… P2 ìŠ¤ì¼€ì¤„ë§ ì•ˆì •í™”
```

### ì •ì„±ì  ì„±ê³¼

**ğŸ¯ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±**
- ê³¼ê±° ì‹œì  ë°ì´í„°ë¡œ ì•ˆì „í•œ í…ŒìŠ¤íŠ¸
- LIVE ë°ì´í„° ë³´í˜¸

**ğŸ”§ ìœ ì§€ë³´ìˆ˜ì„±**
- ì—­í•  ë¶„ë¦¬ë¡œ ë””ë²„ê¹… ìš©ì´
- ë…ë¦½ì  DAG ìˆ˜ì • ê°€ëŠ¥

**ğŸ“ˆ í™•ì¥ì„±**
- ìƒˆë¡œìš´ ë¶„ì„ ì¶”ê°€ ìš©ì´
- íƒ€ DAG ì˜í–¥ ìµœì†Œí™”

**âš¡ ì•ˆì •ì„±**
- ìŠ¤ì¼€ì¤„ë§ ë¬¸ì œ í•´ê²°
- ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

---

## ğŸ”„ Phase 7ì˜ ì˜ë¯¸

### ì•„í‚¤í…ì²˜ ì„±ìˆ™ë„ ë„ì•½

```
Phase 1-4: ê¸°ë°˜ êµ¬ì¶•        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Phase 5-6: ê¸°ëŠ¥ ì¶”ê°€        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Phase 7:   ì•„í‚¤í…ì²˜ ì™„ì„±    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ¨
```

**"ì‘ë™í•˜ëŠ” ì‹œìŠ¤í…œ"ì—ì„œ "ì˜ ì„¤ê³„ëœ ì‹œìŠ¤í…œ"ìœ¼ë¡œ**:
- SRP ì›ì¹™ ì ìš©
- í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ êµ¬ì¡°
- ì•ˆì •ì  ìš´ì˜ í™˜ê²½

### SIMULATION ëª¨ë“œì˜ ì¤‘ìš”ì„±

**ê°œë°œ ì•ˆì „ë§**:
```
ê°œë°œ â†’ SIMULATION í…ŒìŠ¤íŠ¸ â†’ ê²€ì¦ â†’ LIVE ì ìš©
         â†‘
    ê³¼ê±° ë°ì´í„°ë¡œ ì•ˆì „í•˜ê²Œ í…ŒìŠ¤íŠ¸
```

**ì•Œê³ ë¦¬ì¦˜ ë°±í…ŒìŠ¤íŒ…**:
- ê³¼ê±° ì‹œì  ë°ì´í„° ë¶„ì„
- ì „ëµ ê²€ì¦
- ì„±ê³¼ ì‹œë®¬ë ˆì´ì…˜

---

## ğŸ“Š ê¸°ìˆ ì  í•˜ì´ë¼ì´íŠ¸

### 1. DB ìŠ¤ëƒ…ìƒ· ì•„í‚¤í…ì²˜

```python
# LIVE â†’ SIMULATION ìŠ¤ëƒ…ìƒ· ìƒì„±
def create_snapshot(session, target_datetime):
    # 1. ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
    session.execute(text("TRUNCATE simulation.candles CASCADE"))
    
    # 2. ê³¼ê±° ì‹œì  ë°ì´í„° ë³µì œ
    session.execute(text("""
        INSERT INTO simulation.candles
        SELECT * FROM live.candles
        WHERE candle_date_kst <= :target_date
    """), {"target_date": target_datetime})
    
    # 3. ì¬ë¬´ ë°ì´í„° ë³µì œ
    session.execute(text("""
        INSERT INTO simulation.financial_analysis_results
        SELECT * FROM live.financial_analysis_results
        WHERE analysis_date <= :target_date
    """), {"target_date": target_datetime})
```

**ì¥ì **:
- DBë§Œ ì‚¬ìš© (Parquet ë¶ˆí•„ìš”)
- ì™„ì „í•œ ë°ì´í„° ê²©ë¦¬
- ë¹ ë¥¸ ìŠ¤ëƒ…ìƒ· ìƒì„±

### 2. ìˆœìˆ˜ ë¶„ì„ DAG

```python
# dag_daily_batch: ì½ê¸°ë§Œ ìˆ˜í–‰
def analyze_stocks(mode: str):
    # ë°ì´í„° ì½ê¸°
    candles = read_candles(mode)
    financial_data = read_financial_data(mode)
    
    # ë¶„ì„ ìˆ˜í–‰
    results = perform_analysis(candles, financial_data)
    
    # ê²°ê³¼ ì €ì¥ (daily_analysis_results í…Œì´ë¸”)
    save_results(results)
    
    # âœ… candles, financial_data ë³€ê²½ ì—†ìŒ
```

**í•µì‹¬**:
- ì…ë ¥ ë°ì´í„° ë¶ˆë³€
- ì‚¬ì´ë“œ ì´í™íŠ¸ ì—†ìŒ
- ë©±ë“±ì„± ë³´ì¥

### 3. ë™ì  start_date

```python
# P2 ìŠ¤ì¼€ì¤„ë§ ì•ˆì •í™”
default_args = {
    'start_date': pendulum.now('Asia/Seoul').subtract(hours=1),
    'catchup': False,
}
```

**íš¨ê³¼**:
- í•­ìƒ ìµœê·¼ ë‚ ì§œ
- ê³¼ê±° ì‹¤í–‰ ë°©ì§€
- ì˜ë„ëœ ìŠ¤ì¼€ì¤„ë§Œ ì‹¤í–‰

---

## ğŸ“ í•™ìŠµ í¬ì¸íŠ¸

### 1. ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)

**ì˜ëª»ëœ ì„¤ê³„**:
```
dag_daily_batch:
  - ë°ì´í„° ìˆ˜ì§‘
  - ë°ì´í„° ì €ì¥
  - ë°ì´í„° ë¶„ì„  âŒ ë„ˆë¬´ ë§ì€ ì±…ì„
```

**ì˜¬ë°”ë¥¸ ì„¤ê³„**:
```
dag_initial_loader: ìˆ˜ì§‘/ì €ì¥
dag_daily_batch: ë¶„ì„
dag_financials_update: ì¬ë¬´ ìˆ˜ì§‘
  âœ… ê°ì ëª…í™•í•œ ì±…ì„
```

### 2. SIMULATIONì˜ ê°€ì¹˜

**í”„ë¡œë•ì…˜ ë³´í˜¸**:
- LIVE ë°ì´í„° ì ˆëŒ€ ìˆ˜ì • ì•ˆ í•¨
- ì‹¤í—˜ê³¼ ìš´ì˜ ë¶„ë¦¬

**ë¹ ë¥¸ ê²€ì¦**:
- ê³¼ê±° ë°ì´í„°ë¡œ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸
- ê²°ê³¼ í™•ì¸ í›„ LIVE ì ìš©

### 3. Airflow ìŠ¤ì¼€ì¤„ë§ ì´í•´

**start_dateì˜ ì˜ë¯¸**:
- DAG ì‹¤í–‰ ê°€ëŠ¥ ì‹œì‘ì 
- ê³¼ê±° ë‚ ì§œ â†’ catchup ë°œìƒ
- ìµœê·¼ ë‚ ì§œ â†’ ì•ˆì •ì  ìŠ¤ì¼€ì¤„

### 4. ORM vs Raw SQL

**ORMì˜ ì¥ì **:
- ê°ì²´ ì§€í–¥ì 
- íƒ€ì… ì•ˆì „

**Raw SQLì´ í•„ìš”í•œ ê²½ìš°**:
- ë³µì¡í•œ ì¿¼ë¦¬
- ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬
- ORM ë²„ê·¸ íšŒí”¼

---

## ğŸ”— ì—°ê´€ Phase

### ì„ í–‰ Phase

**Phase 5-6**: ë¶„ì„ ê¸°ëŠ¥ êµ¬í˜„
- RS ì ìˆ˜, ì¬ë¬´ ë¶„ì„
- SIMULATIONìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•  ë¡œì§ ì¤€ë¹„

### í›„ì† Phase

**Phase 8**: Filter Zero í†µí•©
- SRP ê¸°ë°˜ í•„í„°ë§ êµ¬í˜„
- SIMULATION ëª¨ë“œ í™œìš©

---

## ğŸ“ ê´€ë ¨ ë¬¸ì„œ

### ìƒìœ„ ë¬¸ì„œ
- **`../../DataPipeline_Project_Roadmap.md`**: Phase 7 ì„¹ì…˜
- **`../../README.md`**: ë¬¸ì„œ ì„¼í„°

### ê´€ë ¨ Phase
- **`../Phase5_RS_Score/`**: ë¶„ì„ ê¸°ëŠ¥ (RS)
- **`../Phase6_DART_API/`**: ë¶„ì„ ê¸°ëŠ¥ (ì¬ë¬´)
- **`../Phase8_Zero_Filter/`**: SRP í™œìš©

### ì°¸ì¡° ë¬¸ì„œ
- **`../../Reference/debugging_commands.md`**: SIMULATION í…ŒìŠ¤íŠ¸

### ê³„íš ë¬¸ì„œ
- **`../../Archive/Plans/SIMULATION ëª¨ë“œ ì•„í‚¤í…ì²˜ ë™ê¸°í™” ê³„íšì„œ.md`**: ì´ˆê¸° ê³„íš

---

## ğŸ’¡ Phase 7 ì´í›„

### í™•ë¦½ëœ ì•„í‚¤í…ì²˜
- âœ… SRP ê¸°ë°˜ DAG êµ¬ì¡°
- âœ… SIMULATION ëª¨ë“œ ì™„ì„±
- âœ… P2 ìŠ¤ì¼€ì¤„ë§ ì•ˆì •í™”
- âœ… DB ìŠ¤ëƒ…ìƒ· ì²´ê³„

### ë‹¤ìŒ ë‹¨ê³„
1. **Phase 8**: ì•„í‚¤í…ì²˜ ê¸°ë°˜ ìµœì í™”
2. **Phase 9**: ì„ íƒì  ë°ì´í„° ìˆ˜ì§‘
3. **Phase 10**: í…Œë§ˆ ë¶„ì„ í†µí•©

---

**Phase 7ì€ DataPipelineì„ "ì‘ë™í•˜ëŠ” ì‹œìŠ¤í…œ"ì—ì„œ "ì˜ ì„¤ê³„ëœ ì‹œìŠ¤í…œ"ìœ¼ë¡œ ì§„í™”ì‹œí‚¨ ê²°ì •ì  ì „í™˜ì ì…ë‹ˆë‹¤.**

ì´ì œ DataPipelineì€:
- âœ… **ì•ˆì „í•˜ê²Œ í…ŒìŠ¤íŠ¸** ê°€ëŠ¥í•˜ë©°
- âœ… **ì‰½ê²Œ í™•ì¥** ê°€ëŠ¥í•˜ê³ 
- âœ… **ì•ˆì •ì ìœ¼ë¡œ ìš´ì˜**ë©ë‹ˆë‹¤

Phase 8ë¶€í„°ëŠ” ì´ íƒ„íƒ„í•œ ê¸°ë°˜ ìœ„ì—ì„œ ì„±ëŠ¥ ìµœì í™”ì™€ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ğŸ—ï¸

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2025-10-31  
**ì‘ì„±ì**: cursor.ai Documentation Manager  
**ë²„ì „**: 1.0

