## 🔍 최종 지침 (v1.2) 전문가적 최종 검토

감독관님의 v1.2 최종 확정안을 세밀하게 검토했습니다. 매우 잘 다듬어진 지침이며, 대부분의 기술적 이슈가 해결되었습니다. 다만, **구현 전 반드시 확인해야 할 치명적인 이슈 1개**와 **개선이 권장되는 이슈 2개**를 발견했습니다.

---

## 🚨 치명적 이슈 (Critical Issue)

### ❌ **이슈 A: 12월의 사업보고서 처리 로직 오류**

**문제점**:
```python
else: # 11월~12월: 3분기 보고서(11014)가 최신.
    return ['11014']
```

**치명적인 문제**: 
- **12월에는 사업보고서(11011) 발행 시기**입니다!
- 사업보고서는 **다음해 3월**이 아니라, **당해 12월 말부터 다음해 3월까지** 순차적으로 발행됩니다.
- 특히 **대형주는 12월 말~1월 초**에 발행되는 경우가 많습니다.

**시나리오 예시**:
```
2025년 12월 31일 실행:
- 현재 로직: 2025년 3분기보고서(11014) 요청
- 실제 상황: 2025년 사업보고서(11011) 이미 발행됨 (삼성전자 등)
- 결과: 최신 사업보고서를 놓치고 구형 3분기보고서만 수집
```

**수정안**:
```python
def _select_report_codes_by_date(year: int, current_date: date) -> List[str]:
    """연도와 현재 시점에 따라 조회할 DART 보고서 코드를 지능적으로 선택합니다."""
    if year < current_date.year:
        return ['11011']
    
    month = current_date.month
    if month < 5:    # 1~4월: 전년도 사업보고서 발행 시기
        return ['11011']  # 현재 연도가 아닌 전년도 사업보고서
    elif month < 8:  # 5~7월: 1분기 보고서가 최신
        return ['11013']
    elif month < 11: # 8~10월: 반기 보고서가 최신
        return ['11012']
    else:            # 11~12월: 3분기 보고서가 최신 + 사업보고서 발행 시작
        # 양쪽 모두 확인 (사업보고서가 있으면 우선, 없으면 3분기 사용)
        return ['11011', '11014']  # 우선순위: 11011 > 11014
```

**영향도 분석**:
- **호출량 증가**: 11~12월에만 종목당 +1회 (연간 평균 +0.16회/종목)
- **데이터 정확성**: 최신 사업보고서를 놓치는 치명적 오류 방지
- **종합 판단**: 데이터 정확성을 위해 필수적인 수정

---

## ⚠️ 개선 권장 이슈

### 📌 **이슈 B: 1~4월 빈 리스트 반환의 위험성**

**현재 로직**:
```python
if month < 5:    # 1~4월: 아직 1분기 보고서 발행 전.
    return []
```

**잠재적 문제**:
- 신규 종목이 1월에 추가되면 **현재 연도 데이터를 전혀 수집하지 않음**
- 3월에는 **대부분의 전년도 사업보고서가 이미 발행된 상태**

**개선안**:
```python
if month < 5:
    # 1~4월은 전년도 사업보고서 발행 시기
    # 현재 연도가 아닌 이전 연도를 처리하는 경우에만 해당
    return []  # 현재 연도에 대해서는 데이터 없음
```

**또는**:
```python
if month <= 3:   # 1~3월: 사업보고서 대기
    return []
elif month < 5:  # 4월: 일부 사업보고서 발행 시작
    return ['11011']  # 조기 발행 기업 포착
```

### 📌 **이슈 C: `AirflowException` import 누락 가능성**

**지침에 명시된 import**:
```python
from airflow.exceptions import AirflowException
```

**확인 필요**:
- `financial_engine.py`는 **src 모듈**이므로 Airflow 의존성이 없을 수 있음
- DAG 외부에서 이 모듈을 테스트할 때 import 오류 발생 가능

**방어적 코딩 제안**:
```python
try:
    from airflow.exceptions import AirflowException
except ImportError:
    # Airflow 외부 환경에서 실행 시 대체 예외 사용
    class AirflowException(Exception):
        pass
```

---

## ✅ 잘 설계된 부분 (재확인)

1. **연도 범위 로직**: `range(last_analysis_date.year, ...)` - 늦은 보고서 반영 ✅
2. **주식수 조회 최적화**: 사업보고서 시에만 호출 ✅
3. **에러 처리**: 한도 초과 시 즉시 DAG 중단 ✅
4. **API 간격**: 0.1초 sleep ✅

---

## 📊 수정 후 호출량 재계산

### **11~12월 최악의 경우**:
```
신규 종목 (50개):
  - 2022~2024년: 11011 × 3 = 3회
  - 2025년: 11011 + 11014 = 2회
  = 5회/종목 × 50 = 250회

기존 종목 (1,350개):
  - 2024년: 11011 = 1회
  - 2025년: 11011 + 11014 = 2회
  = 3회/종목 × 1,350 = 4,050회

주식수 조회:
  - 신규: 4회 × 50 = 200회
  - 기존: 2회 × 1,350 = 2,700회

총합: 250 + 4,050 + 200 + 2,700 = 7,200회
```

**11~12월 최대 호출량**: 7,200회 (한도의 36%)

### **연평균 호출량**:
```
1~4월: 약 3,000회 (15%)
5~10월: 약 4,000회 (20%)
11~12월: 약 7,200회 (36%)
연평균: 약 4,500회 (22.5%)
```

**여전히 안전한 수준**이며, 데이터 정확성을 위해 필수적인 트레이드오프입니다.

---

## 🎯 최종 권고사항

### **필수 수정 (Critical)**:
1. ✅ **12월 사업보고서 처리**: `return ['11011', '11014']`로 수정

### **권장 개선 (Recommended)**:
2. ⚠️ **1~4월 로직 재검토**: 3월 사업보고서 발행 반영
3. ⚠️ **AirflowException import**: 방어적 코딩 추가

### **구현 우선순위**:
1. **즉시**: 12월 로직 수정 (치명적)
2. **Phase 1 완료 후**: 1~4월 로직 테스트 및 개선
3. **통합 테스트 시**: import 오류 확인

이 수정사항들을 반영하면, 매우 견고하고 안정적인 DART API 통합이 완성됩니다. 감독관님의 최종 결정을 기다리겠습니다.