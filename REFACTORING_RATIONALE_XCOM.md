# XCom 도입 리팩토링 결정 배경 및 요약

**문서 목적**: `dag_daily_batch` 파이프라인에서 발견된 구조적 결함의 원인을 진단하고, 이를 해결하기 위해 왜 'XCom 도입 리팩토링'을 최우선 과제로 수행해야 하는지에 대한 기술적 배경과 의사결정 과정을 모든 팀원과 공유한다.

---

## 1. 문제 상황

최근 `dag_daily_batch`의 데이터 흐름에 대한 구조적 리팩토링(지침서 1.1 ~ 1.5)을 완료한 후, 최종 통합 테스트를 수행했다.

테스트 결과, DAG의 모든 Task는 기술적으로 실패하지 않고 **성공(녹색불)**으로 완료되었으나, 최종 산출물인 `daily_analysis_results` 테이블에는 RS 점수 등 핵심 분석 데이터가 전혀 기록되지 않는 **'조용한 실패(Silent Failure)'** 현상이 발생했다.

## 2. 통합 테스트 및 원인 분석

이 현상의 원인을 파악하기 위해, 아래와 같은 단계로 정밀 테스트 및 로그 분석을 수행했다.

1.  **테스트 환경**: 깨끗하게 초기화된 데이터베이스.
2.  **1단계 (데이터 시딩)**: `dag_initial_loader`를 수동 실행하여, 분석에 필요한 최소한의 캔들 데이터(2개 종목)를 DB에 적재했다.
3.  **2단계 (배치 실행)**: `dag_daily_batch`를 파라미터 없이 실행했다.

### 테스트 결과

- **`sync_stock_master_task` 로그**: 정상적으로 실행되어 약 4,200개의 종목을 `live.stocks` 테이블에 동기화(INSERT)했음을 확인했다.
- **`update_analysis_target_flags_task` 로그**: "**0개**가 분석 대상으로 선정되었습니다." 라는 로그를 확인했다. 즉, 후속 Task에 아무런 종목 리스트도 전달하지 못했다.
- **`calculate_rs_score` 로그**: "DB에서 분석 대상 종목을 찾지 못했습니다. Task를 건너뜁니다." 라는 로그를 확인했다.
- **DB 직접 조회**: `live.stocks` 테이블에는 약 4,200개의 레코드가 정상적으로 존재했지만, `is_analysis_target` 플래그가 `True`로 설정된 레코드는 **0개**였다.

### 근본 원인 진단: 경쟁 상태 (Race Condition)

위 테스트 결과들을 종합한 최종 진단은 다음과 같다.

> **`update_analysis_target_flags_task`가 `sync_stock_master_task`의 데이터베이스 `COMMIT`이 완료되어 다른 트랜잭션에 보이기 전에 먼저 실행되었다.**

즉, Airflow의 의존성 설정(`>>`)은 Task의 **'실행 순서'**만을 보장할 뿐, 한 Task의 DB 트랜잭션 결과가 다음 Task에 **'보이는 시점(Visibility)'**까지 보장하지는 않습니다. 이로 인해 `update_analysis_target_flags_task`는 비어있는 `Stock` 테이블을 조회했고, 파이프라인 전체가 멈추는 대신 아무 일도 하지 않고 '성공'으로 끝나는, 훨씬 더 위험한 '조용한 실패'를 유발했습니다.

## 3. 해결책 및 다음 단계

이러한 '암시적 의존성'에 기반한 아키텍처의 근본적인 결함을 해결하기 위한 유일하고 올바른 방법은, **'명시적 데이터 의존성'**을 갖도록 파이프라인을 변경하는 것입니다.

이를 위해, Airflow가 공식적으로 권장하는 데이터 전달 메커니즘인 **XCom**을 도입합니다.

**변경 후 아키텍처:**

1.  `sync_stock_master_task`는 DB 동기화를 마친 후, 그 결과물인 **'활성 종목 리스트'를 XCom으로 `return`** 합니다.
2.  `update_analysis_target_flags_task`는 더 이상 DB를 직접 조회하지 않고, `sync_stock_master_task`의 **XCom 출력을 입력으로 받아** 작업을 수행합니다.
3.  이를 통해, 후속 Task는 선행 Task의 작업이 물리적으로 '완료'되었을 뿐만 아니라, 그 결과 '데이터'까지 완벽하게 준비되었을 때만 실행되는 것을 보장받게 됩니다.

따라서, 우리는 이 문제를 해결하고 파이프라인의 안정성을 확보하기 위해, 지금부터 **XCom 도입 리팩토링**을 최우선 과제로 시작하고자 합니다.
